<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel del DJ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
    body {
      background: #121826 url('https://raw.githubusercontent.com/appyem/imagens-manager-pro/refs/heads/main/ChatGPT%20Image%208%20ene%202026%2C%2004_10_16%20p.m..png') center/cover fixed;
      min-height: 100vh;
      padding: 16px;
      color: white;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    
    /* Header */
    .header { background: rgba(0,0,0,0.3); backdrop-filter: blur(10px); padding: 20px; border-radius: 16px; margin-bottom: 24px; border: 1px solid rgba(255,255,255,0.1); }
    .header-content h1 { font-size: 28px; font-weight: 700; margin-bottom: 8px; display: flex; align-items: center; gap: 12px; }
    .header-content h1 span { font-size: 32px; }
    .header-content p { font-size: 14px; opacity: 0.8; }
    
    /* Stats */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 32px; }
    .stat-card { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 16px; padding: 24px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
    .stat-label { font-size: 14px; margin-bottom: 8px; opacity: 0.8; }
    .stat-value { font-size: 36px; font-weight: 700; margin-bottom: 4px; }
    .stat-value.pendientes { color: #fbbf24; }
    .stat-value.reproducidas { color: #34d399; }
    
    /* Main Content */
    .main-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; }
    .card { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 16px; padding: 24px; margin-bottom: 24px; border: 1px solid rgba(255,255,255,0.1); }
    .card h2 { font-size: 20px; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
    .card h2 span { font-size: 24px; }
    
    /* Peticiones */
    .peticiones-list { max-height: 600px; overflow-y: auto; }
    .peticion-item { padding: 16px; margin-bottom: 12px; background: rgba(255,255,255,0.05); border-radius: 12px; border-left: 4px solid #fbbf24; }
    .peticion-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .peticion-orden { background: #fbbf24; color: #1c1917; padding: 4px 12px; border-radius: 20px; font-weight: 600; font-size: 14px; }
    .peticion-cancion { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
    .peticion-artista { font-size: 14px; color: #f3f4f6; opacity: 0.8; margin-bottom: 12px; }
    .peticion-info { display: flex; justify-content: space-between; font-size: 12px; opacity: 0.8; }
    .reproducida-btn { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; width: 100%; margin-top: 12px; transition: transform 0.2s; }
    .reproducida-btn:hover { transform: translateY(-2px); }
    .reproducida-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    
    /* Historial */
    .historial-list { max-height: 400px; overflow-y: auto; }
    .historial-item { padding: 12px; margin-bottom: 8px; background: rgba(52, 211, 153, 0.1); border-radius: 12px; border-left: 4px solid #34d399; display: flex; align-items: center; gap: 12px; }
    .historial-check { font-size: 20px; color: #34d399; }
    
    /* Bot√≥n limpiar */
    .limpiar-btn { background: rgba(239, 68, 68, 0.2); border: 1px solid #ef4444; color: #fca5a5; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 16px; transition: background 0.2s; }
    .limpiar-btn:hover { background: rgba(239, 68, 68, 0.3); }
    
    @media (max-width: 768px) {
      .main-grid { grid-template-columns: 1fr; }
      .header { padding: 16px; }
      .stats-grid { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="header-content">
        <div style="display: flex; align-items: center; gap: 12px;">
          <img src="https://raw.githubusercontent.com/appyem/imagenesappy/refs/heads/main/ChatGPT%20Image%206%20ene%202026%2C%2006_33_51%20p.m..png" alt="AppyEmpresa S.A.S" style="width: 32px; height: 32px; object-fit: contain;">
          <span>üéß Panel del DJ</span>
        </div>
        <p id="tenantInfo">Cargando informaci√≥n del tenant...</p>
      </div>
    </div>
    
    <!-- Estad√≠sticas -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Peticiones Pendientes</div>
        <div class="stat-value pendientes" id="pendientesCount">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Canciones Reproducidas</div>
        <div class="stat-value reproducidas" id="reproducidasCount">0</div>
      </div>
    </div>
    
    <!-- Contenido Principal -->
    <div class="main-grid">
      <!-- Peticiones Pendientes -->
      <div class="card">
        <h2><span>üìù</span> Peticiones Pendientes</h2>
        <div id="peticionesContainer" class="peticiones-list">
          <p style="text-align: center; opacity: 0.7; padding: 20px;">No hay peticiones pendientes</p>
        </div>
      </div>
      
      <!-- Historial de Reproducidas -->
      <div class="card">
        <h2><span>‚úÖ</span> Historial de Reproducidas</h2>
        <div id="historialContainer" class="historial-list">
          <p style="text-align: center; opacity: 0.7; padding: 20px;">No hay canciones reproducidas</p>
        </div>
        <button id="limpiarHistorial" class="limpiar-btn" style="display: none;">Limpiar Historial</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK (modo compat - igual que cashier.html) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    // === CONFIGURACI√ìN DE FIREBASE ===
    const firebaseConfig = {
      apiKey: "AIzaSyCYuZRqdrR4ZcQ97T6lU8vIqFw58cSM4hA",
      authDomain: "manager-pro-ec292.firebaseapp.com",
      projectId: "manager-pro-ec292",
      storageBucket: "manager-pro-ec292.firebasestorage.app",
      messagingSenderId: "1077289364014",
      appId: "1:1077289364014:web:a6bcea3c7ea2923ad4cdbf"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Variables
    let currentTenantId = null;
    let cancionesReproducidas = new Set();
    let unsubscribePeticiones = null;

    // === EXTRAER DATOS DE LA URL (mismo m√©todo que cashier.html) ===
    function getDjData() {
      const params = new URLSearchParams(window.location.search);
      const dataParam = params.get('data');
      if (!dataParam) return null;
      
      try {
        const decoded = decodeURIComponent(dataParam);
        const jsonStr = atob(decoded);
        return JSON.parse(jsonStr);
      } catch (e) {
        console.error('Error al decodificar datos del DJ:', e);
        return null;
      }
    }

    // === INICIAR PANEL DEL DJ ===
    async function initDJ() {
      const data = getDjData();
      if (!data || !data.tenantId) {
        document.getElementById('tenantInfo').textContent = '‚ùå Error: URL inv√°lida. Use el enlace del panel de administrador.';
        alert('Acceda al panel del DJ desde el panel de administraci√≥n.');
        return;
      }
      
      currentTenantId = data.tenantId;
      //document.getElementById('tenantInfo').textContent = `Tenant: ${currentTenantId.substring(0, 8)}...`;
      iniciarEscuchaPeticiones();
      cargarHistorial();
    }

    // === ESCUCHAR PETICIONES SIN √çNDICE ===
    function iniciarEscuchaPeticiones() {
      if (unsubscribePeticiones) {
        unsubscribePeticiones();
      }
      
      // üî• Consulta SIN orderBy (evita necesidad de √≠ndice)
      const peticionesRef = db.collection(`tenants/${currentTenantId}/peticionesCancion`);
      const q = peticionesRef.where('estado', '==', 'pendiente');
      
      unsubscribePeticiones = q.onSnapshot((snapshot) => {
        const peticiones = [];
        snapshot.forEach(doc => {
          peticiones.push({ id: doc.id, ...doc.data() });
        });
        
        // üî• Ordenar manualmente en JavaScript (m√°s antiguo primero)
        peticiones.sort((a, b) => {
          const aTime = a.createdAt?.seconds || 0;
          const bTime = b.createdAt?.seconds || 0;
          return aTime - bTime;
        });
        
        renderPeticiones(peticiones);
      }, (error) => {
        console.error('Error en listener de peticiones:', error);
        document.getElementById('peticionesContainer').innerHTML = 
          `<p style="text-align: center; color: #ef4444; padding: 20px;">Error: ${error.message}</p>`;
      });
    }

    // === RENDERIZAR PETICIONES ===
    function renderPeticiones(peticiones) {
      const container = document.getElementById('peticionesContainer');
      const countElement = document.getElementById('pendientesCount');
      countElement.textContent = peticiones.length;
      
      if (peticiones.length === 0) {
        container.innerHTML = '<p style="text-align: center; opacity: 0.7; padding: 20px;">No hay peticiones pendientes</p>';
        return;
      }
      
      let html = '';
      peticiones.forEach((peticion, index) => {
        const key = peticion.artista ? `${peticion.cancion} - ${peticion.artista}` : peticion.cancion;
        const yaReproducida = cancionesReproducidas.has(key);
        
        html += `
          <div class="peticion-item">
            <div class="peticion-header">
              <div class="peticion-orden">#${index + 1}</div>
            </div>
            <div class="peticion-cancion">${peticion.cancion}</div>
            ${peticion.artista ? `<div class="peticion-artista">por ${peticion.artista}</div>` : ''}
            <div class="peticion-info">
              <span>Mesa: ${peticion.mesa}</span>
              <span>Mesero: ${peticion.mesero}</span>
            </div>
            ${!yaReproducida ? `
              <button class="reproducida-btn" onclick="marcarReproducida('${peticion.id}', '${peticion.cancion}', '${peticion.artista || ''}')">
                <span>‚úì</span> Marcar como Reproducida
              </button>
            ` : `
              <div style="padding: 8px 16px; background: rgba(52, 211, 153, 0.2); border-radius: 8px; text-align: center; color: #34d399; font-weight: 600;">
                Ya Reproducida
              </div>
            `}
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    // === MARCAR COMO REPRODUCIDA ===
    window.marcarReproducida = async function(peticionId, cancion, artista) {
      if (!currentTenantId) return;
      
      try {
        await db.collection(`tenants/${currentTenantId}/peticionesCancion`).doc(peticionId).update({
          estado: 'reproducida',
          reproducidaAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        const key = artista ? `${cancion} - ${artista}` : cancion;
        cancionesReproducidas.add(key);
        guardarHistorial();
        renderHistorial();
        document.getElementById('limpiarHistorial').style.display = 'block';
        
      } catch (error) {
        alert('‚ùå Error al marcar como reproducida: ' + error.message);
      }
    };

    // === GESTI√ìN DEL HISTORIAL (localStorage) ===
    function cargarHistorial() {
      const saved = localStorage.getItem(`dj_historial_${currentTenantId}`);
      if (saved) {
        cancionesReproducidas = new Set(JSON.parse(saved));
        renderHistorial();
        if (cancionesReproducidas.size > 0) {
          document.getElementById('limpiarHistorial').style.display = 'block';
        }
      }
    }

    function guardarHistorial() {
      localStorage.setItem(`dj_historial_${currentTenantId}`, JSON.stringify(Array.from(cancionesReproducidas)));
    }

    function renderHistorial() {
      const container = document.getElementById('historialContainer');
      const countElement = document.getElementById('reproducidasCount');
      countElement.textContent = cancionesReproducidas.size;
      
      if (cancionesReproducidas.size === 0) {
        container.innerHTML = '<p style="text-align: center; opacity: 0.7; padding: 20px;">No hay canciones reproducidas</p>';
        return;
      }
      
      let html = '';
      cancionesReproducidas.forEach(cancion => {
        html += `
          <div class="historial-item">
            <span class="historial-check">‚úì</span>
            <span>${cancion}</span>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    // === LIMPIAR HISTORIAL ===
    document.getElementById('limpiarHistorial').addEventListener('click', function() {
      if (confirm('¬øEst√°s seguro de limpiar el historial de canciones reproducidas?')) {
        cancionesReproducidas.clear();
        guardarHistorial();
        renderHistorial();
        this.style.display = 'none';
      }
    });

    // === INICIAR ===
    initDJ();

    // === LIMPIAR LISTENER AL SALIR ===
    window.addEventListener('beforeunload', () => {
      if (unsubscribePeticiones) {
        unsubscribePeticiones();
      }
    });
  </script>

  <!-- Footer -->
    <div style="text-align: center; margin-top: 30px; padding: 15px; color: rgba(255,255,255,0.8); font-size: 13px; background: rgba(0,0,0,0.2); border-radius: 12px;">
      <img src="https://raw.githubusercontent.com/appyem/imagenesappy/refs/heads/main/ChatGPT%20Image%2030%20dic%202025%2C%2007_50_08%20p.m..png" alt="AppyEmpresa S.A.S" style="width: 30px; height: 30px; object-fit: contain; vertical-align: middle; margin-right: 6px;">
      Desarrollado por AppyEmpresa S.A.S
    </div>

</body>
</html>

