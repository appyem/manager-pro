<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Panel de Mesero</title>
<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Cormorant+Garamond:wght@600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">
<script>
tailwind.config = {
  darkMode: "class",
  theme: {
    extend: {
      colors: {
        "primary": "#C7794E",
        "background-light": "#f6f6f8",
        "background-dark": "#1A1D21",
      },
      fontFamily: {
        "display": ["Plus Jakarta Sans"],
        "heading": ["Cormorant Garamond"]
      },
      borderRadius: {"DEFAULT": "0.5rem", "lg": "1rem", "xl": "1.5rem", "full": "9999px"},
    },
  }
}
</script>
<style>
.glass {
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border: 1px solid rgba(255, 255, 255, 0.1)
}
.glass-dark {
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border: 1px solid rgba(255, 255, 255, 0.08)
}
.bg-bokeh {
  background-image: linear-gradient(rgba(26, 29, 33, 0.85), rgba(26, 29, 33, 0.95)), url('https://raw.githubusercontent.com/appyem/imagens-manager-pro/refs/heads/main/ChatGPT%20Image%208%20ene%202026%2C%2004_10_16%20p.m..png');
  background-size: cover;
  background-position: center
}
body {
  min-height: max(884px, 100dvh);
  font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  color: #FFFFFF;
}
.no-scrollbar::-webkit-scrollbar {
  display: none;
}
.no-scrollbar {
  -ms-overflow-style: none;
  scrollbar-width: none;
}
/* Estilos adicionales para otras secciones */
.card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(12px);
  border-radius: 16px;
  padding: 24px;
  margin-bottom: 24px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
  border: 1px solid rgba(255, 255, 255, 0.1);
}
.btn {
  padding: 10px 16px;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
  border: none;
  font-size: 16px;
  transition: all 0.2s;
}
.btn-primary {
  background: #C7794E;
  color: white;
}
.btn-secondary {
  background: rgba(199, 121, 78, 0.2);
  color: #F0E6D2;
}
.btn-success {
  background: linear-gradient(135deg, #C7794E 0%, #A65A3B 100%);
  color: white;
  width: 100%;
  margin-top: 16px;
  padding: 14px;
  font-size: 18px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(199, 121, 78, 0.3);
}
/* Men√∫ */
.articulo-card {
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(8px);
  border-radius: 12px;
  padding: 16px;
  text-align: center;
  transition: transform 0.2s;
  border: 1px solid rgba(255, 255, 255, 0.08);
}
.articulo-nombre {
  font-weight: 700;
  font-size: 15px;
  color: #FFFFFF;
  background: rgba(0, 0, 0, 0.4);
  padding: 6px 12px;
  border-radius: 8px;
  display: inline-block;
  margin: 0 auto 8px;
  text-align: center;
  width: calc(100% - 24px);
  box-sizing: border-box;
}
.articulo-precio { color: #8A9B68; font-weight: 700; font-size: 18px; margin-bottom: 4px; }
.articulo-stock { font-size: 12px; color: #94a3b8; }
.agregar-btn {
  background: linear-gradient(135deg, #8A9B68 0%, #6B7B54 100%);
  color: #1A1D21;
  border: none;
  padding: 6px 12px;
  border-radius: 6px;
  margin-top: 8px;
  cursor: pointer;
  width: 100%;
  font-weight: 600;
}
/* Pedido acumulado */
.pedido-items { margin-bottom: 20px; max-height: 400px; overflow-y: auto; }
.pedido-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #334155; }
.item-info { font-weight: 600; }
.item-actions { display: flex; gap: 8px; }
.item-btn {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: #334155;
  color: white;
  border: none;
  font-weight: bold;
  cursor: pointer;
}
.pedido-total {
  font-size: 24px;
  font-weight: 800;
  text-align: right;
  margin: 20px 0;
  color: #8A9B68;
}
/* Cierre de Caja */
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin: 20px 0; }
.stat-card { background: rgba(51, 65, 85, 0.6); padding: 16px; border-radius: 12px; text-align: center; }
.stat-value { font-size: 22px; font-weight: 700; margin: 8px 0; color: #C7794E; }
.stat-label { font-size: 13px; opacity: 0.8; }
/* DJ */
.dj-section { margin-top: 30px; padding-top: 20px; border-top: 1px solid #334155; }
.dj-btn {
  background: linear-gradient(135deg, #8A9B68 0%, #C7794E 100%);
  color: white;
  padding: 12px;
  border: none;
  border-radius: 10px;
  font-weight: 600;
  width: 100%;
  margin-top: 16px;
  cursor: pointer;
}
/* Estados de mesas */
.mesa-estado.libre, .table-status.libre {
  background: #2F5D51;
  color: #F0E6D2;
}
.mesa-estado.pendiente, .table-status.pendiente {
  background: #C7794E;
  color: #1A1D21;
}
.mesa-estado.pagada, .table-status.pagada {
  background: #8A9B68;
  color: #1A1D21;
}
</style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-white selection:bg-primary/30">
<!-- Background Layer -->
<div class="fixed inset-0 bg-bokeh z-0"></div>
<!-- Main Container -->
<div class="relative z-10 flex h-screen w-full flex-col overflow-hidden max-w-md mx-auto border-x border-white/5">
<!-- TopAppBar (Glass) -->
<header class="sticky top-0 z-50 glass-dark px-4 pt-6 pb-4">
<div class="flex items-center justify-between">
<div class="flex items-center gap-3">
<div class="size-10 shrink-0 rounded-full border-2 border-primary overflow-hidden">
<img class="h-full w-full object-cover" src="https://raw.githubusercontent.com/appyem/imagenesappy/refs/heads/main/ChatGPT%20Image%206%20ene%202026%2C%2006_33_51%20p.m..png" alt="AppyEmpresa S.A.S"/>
</div>
<div>
<p class="text-[10px] uppercase tracking-wider text-white/50 font-bold">Panel de Control</p>
<h2 class="text-white text-lg font-bold leading-tight" id="meseroNombre">Cargando Panel...</h2>
</div>
</div>
<button id="btnCierreCaja" class="flex items-center gap-2 rounded-xl bg-white/10 px-3 py-2 text-sm font-semibold text-white active:scale-95 transition-transform" onclick="mostrarCierreCaja()">
<span class="material-symbols-outlined text-emerald-400 text-lg">payments</span>
<span>Cierre</span>
</button>
</div>
</header>

<!-- Main Content Area -->
<main class="flex-1 overflow-y-auto pb-24 px-4">
<!-- Vista: Selecci√≥n de Mesas -->
<div id="view-mesas">
<!-- Chips de zonas se generar√°n din√°micamente -->
<div id="chipsZonas" class="flex gap-3 py-6 overflow-x-auto no-scrollbar"></div>
<!-- Cuadr√≠cula de mesas se generar√° din√°micamente -->
<div id="gridMesas" class="grid grid-cols-2 gap-4 pb-10"></div>
</div>

<!-- Vista: Pedido de Mesa -->
<div id="view-pedido" class="hidden">
<div class="mesa-header">
<div class="mesa-title">Mesa <span id="mesaNumero">?</span></div>
<div>Estado: <span id="mesaEstado" class="mesa-estado pendiente">Cargando...</span></div>
</div>
<div class="pedido-layout">
<!-- Men√∫ + DJ -->
<div class="card">
<h3 style="margin-bottom: 20px; color: #F0E6D2;">üç∑ Men√∫</h3>
<div id="menuContainer">
<p style="text-align: center; color: #94a3b8;">Cargando men√∫...</p>
</div>
<!-- DJ -->
<div class="dj-section">
<h3 style="color: #F0E6D2; margin-bottom: 12px;">üéµ Pedir Canci√≥n al DJ</h3>
<div class="form-group">
<input type="text" id="cancionInput" placeholder="Nombre de la canci√≥n" style="width:100%; padding:10px; border-radius:8px; margin-bottom:8px; background:rgba(0,0,0,0.3); color:#F0E6D2; border:1px solid #334155;">
</div>
<div class="form-group">
<input type="text" id="artistaInput" placeholder="Artista (opcional)" style="width:100%; padding:10px; border-radius:8px; background:rgba(0,0,0,0.3); color:#F0E6D2; border:1px solid #334155;">
</div>
<button class="dj-btn" onclick="solicitarCancion()">Enviar al DJ</button>
</div>
</div>
<!-- Pedido Acumulado -->
<div class="card">
<h3 style="margin-bottom: 20px; color: #F0E6D2;">üõí Pedido Actual</h3>
<div id="pedidoAcumulado">
<p style="text-align: center; color: #94a3b8;">No hay art√≠culos</p>
</div>
<div class="pedido-total">Total: $<span id="totalPedido">0</span></div>
<div class="form-group" style="margin: 20px 0;">
<label style="display:block; margin-bottom:8px; color:#cbd5e1;">Forma de Pago</label>
<select id="formaPago" style="width:100%; padding:12px; border-radius:8px; background:rgba(0,0,0,0.3); color:#F0E6D2; border:1px solid #334155;">
<option value="efectivo">Efectivo</option>
<option value="tarjeta">Tarjeta</option>
<option value="nequi">Nequi</option>
<option value="daviplata">Daviplata</option>
</select>
</div>
<div id="contenedorQr" style="text-align: center; margin: 20px 0; display: none;">
<div style="width: 200px; height: 200px; margin: 0 auto; border: 2px dashed #334155; border-radius: 12px; background: #0f172a; display: flex; align-items: center; justify-content: center;">
<img id="qrPagoMesero" src="" alt="C√≥digo QR de Pago" style="max-width: 100%; max-height: 100%; object-fit: contain; display: none;">
<span id="qrPlaceholderMesero" style="color: #94a3b8; font-size: 14px;">Cargando c√≥digo QR...</span>
</div>
</div>
<button id="btnRealizarPedido" class="btn btn-secondary" style="margin-bottom:12px; width:100%;" onclick="realizarPedido()">üì§ Realizar Pedido</button>
<button id="btnPagar" class="btn btn-success" onclick="procesarPagoActual()" disabled>‚úÖ Pagar Pedido</button>
</div>
</div>
</div>

<!-- Vista: Cierre de Caja -->
<div id="view-cierre" class="hidden">
<div class="card">
<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
<h2 style="color:#F0E6D2;">
<span class="material-symbols-outlined text-emerald-400 text-lg">payments</span>
Cierre de Caja - Hoy
</h2>
<button class="btn btn-secondary" onclick="volverAMesas()">‚Üê Volver</button>
</div>
<div class="stats-grid">
<div class="stat-card">
<div class="stat-label">Total Vendido</div>
<div class="stat-value">$<span id="totalVendido">0</span></div>
</div>
<div class="stat-card">
<div class="stat-label">Mesas Atendidas</div>
<div class="stat-value"><span id="mesasAtendidas">0</span></div>
</div>
<div class="stat-card">
<div class="stat-label">Pedidos Pagados</div>
<div class="stat-value"><span id="pedidosPagados">0</span></div>
</div>
<div class="stat-card">
<div class="stat-label">Art√≠culos Vendidos</div>
<div class="stat-value"><span id="articulosVendidos">0</span></div>
</div>
</div>
<h3 style="color:#F0E6D2; margin:20px 0;">Top Art√≠culos Vendidos</h3>
<div id="topArticulos">
<p style="text-align:center; color:#94a3b8;">No hay ventas hoy</p>
</div>
</div>
</div>
</main>

<!-- BottomNavBar (Glass) -->
<nav class="fixed bottom-0 left-0 right-0 z-50 px-4 pb-6 pt-2">
<div class="mx-auto max-w-md glass-dark rounded-full px-6 py-2 flex items-center justify-between shadow-2xl">
<a class="flex flex-col items-center gap-1 text-primary" href="#" onclick="volverAMesas(); return false;">
<div class="h-8 flex items-center justify-center">
<span class="material-symbols-outlined text-[28px] fill-[1]">grid_view</span>
</div>
<p class="text-[10px] font-bold uppercase tracking-wide">Mesas</p>
</a>
<a class="flex flex-col items-center gap-1 text-white/40" href="#" onclick="mostrarPedidos(); return false;">
<div class="h-8 flex items-center justify-center">
<span class="material-symbols-outlined text-[28px]">receipt_long</span>
</div>
<p class="text-[10px] font-bold uppercase tracking-wide">Pedidos</p>
</a>
<a class="flex flex-col items-center gap-1 text-white/40" href="#" onclick="mostrarDj(); return false;">
<div class="h-8 flex items-center justify-center">
<span class="material-symbols-outlined text-[28px]">music_note</span>
</div>
<p class="text-[10px] font-bold uppercase tracking-wide">DJ</p>
</a>
<a class="flex flex-col items-center gap-1 text-white/40" href="#" onclick="mostrarCierreCaja(); return false;">
<div class="h-8 flex items-center justify-center">
<span class="material-symbols-outlined text-[28px]">bar_chart_4_bars</span>
</div>
<p class="text-[10px] font-bold uppercase tracking-wide">Stats</p>
</a>
</div>
</nav>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script>
// === CONFIGURACI√ìN EXACTAMENTE IGUAL ===
const firebaseConfig = {
apiKey: "AIzaSyCYuZRqdrR4ZcQ97T6lU8vIqFw58cSM4hA",
authDomain: "manager-pro-ec292.firebaseapp.com",
projectId: "manager-pro-ec292",
storageBucket: "manager-pro-ec292.firebasestorage.app",
messagingSenderId: "1077289364014",
appId: "1:1077289364014:web:a6bcea3c7ea2923ad4cdbf"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
let currentMesero = null;
let currentTenantId = null;
let currentMesaId = null;
let currentMesaNumero = null;
let pedidoActivo = null;
const carritosPorMesa = {};
let carritoLocal = [];

// === FUNCIONES EXISTENTES SIN CAMBIOS ===
function getMeseroData() {
const params = new URLSearchParams(window.location.search);
const dataParam = params.get('data');
if (!dataParam) return null;
try {
const decoded = decodeURIComponent(dataParam);
const jsonStr = atob(decoded);
return JSON.parse(jsonStr);
} catch (e) {
console.error('Error al decodificar datos:', e);
return null;
}
}

// Nueva funci√≥n para renderizar mesas con el nuevo dise√±o
function renderMesas(mesas) {
const zonas = ['Terraza', 'Bar Principal', 'Zona VIP', 'Pista de Baile'];
  
// Renderizar chips de zonas
let chipsHtml = '';
zonas.forEach(zona => {
  const tieneMesas = mesas.some(m => m.ubicacion === zona);
  if (tieneMesas) {
    chipsHtml += `<div class="flex h-10 shrink-0 items-center justify-center rounded-xl glass px-5">
      <p class="text-white/70 text-sm font-medium">${zona}</p>
    </div>`;
  }
});
document.getElementById('chipsZonas').innerHTML = chipsHtml;

// Renderizar tarjetas de mesas
let gridHtml = '';
mesas.forEach(mesa => {
  const estadoClass = mesa.estado === 'libre' ? 'emerald' : 'amber';
  const estadoTexto = mesa.estado === 'libre' ? 'Libre' : 'Pendiente';
  const icono = mesa.estado === 'pendiente' ? 'shopping_cart' : 'table_restaurant';
  const colorIcono = mesa.estado === 'pendiente' ? 'text-primary' : 'text-white/60';
  const animacion = mesa.estado === 'pendiente' ? 'animate-pulse' : '';
  
  gridHtml += `
  <div class="glass p-4 rounded-xl flex flex-col gap-4 relative overflow-hidden group" onclick="seleccionarMesa('${mesa.id}', '${mesa.numero}')">
    <div class="absolute top-0 right-0 p-2">
      <div class="flex items-center gap-1.5 px-2 py-1 rounded-lg bg-${estadoClass}-500/20 text-${estadoClass}-400 border border-${estadoClass}-500/30">
        <span class="size-1.5 rounded-full bg-${estadoClass}-400 ${animacion}"></span>
        <span class="text-[10px] font-bold uppercase tracking-tight">${estadoTexto}</span>
      </div>
    </div>
    <div class="size-12 rounded-lg bg-white/5 flex items-center justify-center">
      <span class="material-symbols-outlined ${colorIcono}">${icono}</span>
    </div>
    <div>
      <p class="text-white text-lg font-bold leading-tight">Mesa ${mesa.numero}</p>
      <p class="text-white/40 text-xs mt-1">${mesa.capacidad} Personas</p>
    </div>
  </div>`;
});
document.getElementById('gridMesas').innerHTML = gridHtml || '<p class="text-center text-white/50 col-span-2">No hay mesas disponibles</p>';
}

function renderMenu(articulos) {
const categorias = [...new Set(articulos.map(a => a.categoria).filter(c => c))];
let html = '<div class="categorias-filtros"><button class="categoria-btn active" onclick="filtrarCategoria(\'all\')">Todos</button>';
categorias.forEach(cat => {
html += `<button class="categoria-btn" onclick="filtrarCategoria('${cat}')">${cat}</button>`;
});
html += '</div><div class="articulos-grid">';
articulos.forEach(art => {
html += `<div class="articulo-card">
<div class="articulo-nombre">${art.nombre}</div>
<div class="articulo-precio">$${art.precio.toLocaleString()}</div>
<div class="articulo-stock">Stock: ${art.stock}</div>
<button class="agregar-btn" onclick="agregarAlPedido('${art.id}', '${art.nombre}', ${art.precio})">+</button>
</div>`;
});
html += '</div>';
document.getElementById('menuContainer').innerHTML = html;
}

// Variable global para almacenar todos los art√≠culos
let articulosOriginales = [];

// Modificar la funci√≥n renderMenu para guardar los art√≠culos originales
function renderMenu(articulos) {
articulosOriginales = articulos; // Guardar copia original
  
const categorias = [...new Set(articulos.map(a => a.categoria).filter(c => c))];
let html = '<div class="categorias-filtros"><button class="categoria-btn active" onclick="filtrarCategoria(\'all\')">Todos</button>';
categorias.forEach(cat => {
html += `<button class="categoria-btn" onclick="filtrarCategoria('${cat}')">${cat}</button>`;
});
html += '</div><div class="articulos-grid" id="articulosGrid">';
  
// Renderizar todos los art√≠culos inicialmente
articulos.forEach(art => {
html += `<div class="articulo-card">
<div class="articulo-nombre">${art.nombre}</div>
<div class="articulo-precio">$${art.precio.toLocaleString()}</div>
<div class="articulo-stock">Stock: ${art.stock}</div>
<button class="agregar-btn" onclick="agregarAlPedido('${art.id}', '${art.nombre}', ${art.precio})">+</button>
</div>`;
});
html += '</div>';
document.getElementById('menuContainer').innerHTML = html;
}

// Nueva funci√≥n de filtrado
function filtrarCategoria(categoria) {
// Actualizar botones activos
document.querySelectorAll('.categoria-btn').forEach(btn => btn.classList.remove('active'));
event.target.classList.add('active');
  
// Filtrar art√≠culos
let articulosFiltrados;
if (categoria === 'all') {
articulosFiltrados = articulosOriginales;
} else {
articulosFiltrados = articulosOriginales.filter(art => art.categoria === categoria);
}
  
// Re-renderizar solo los art√≠culos filtrados
const grid = document.getElementById('articulosGrid');
if (!grid) return;
  
let html = '';
articulosFiltrados.forEach(art => {
html += `<div class="articulo-card">
<div class="articulo-nombre">${art.nombre}</div>
<div class="articulo-precio">$${art.precio.toLocaleString()}</div>
<div class="articulo-stock">Stock: ${art.stock}</div>
<button class="agregar-btn" onclick="agregarAlPedido('${art.id}', '${art.nombre}', ${art.precio})">+</button>
</div>`;
});
grid.innerHTML = html;
}

function seleccionarMesa(mesaId, mesaNumero) {
if (currentMesaId) {
carritosPorMesa[currentMesaId] = carritoLocal;
}
currentMesaId = mesaId;
currentMesaNumero = mesaNumero;
carritoLocal = carritosPorMesa[mesaId] || [];
document.getElementById('mesaNumero').textContent = mesaNumero;
document.getElementById('view-mesas').classList.add('hidden');
document.getElementById('view-pedido').classList.remove('hidden');
cargarArticulos(currentTenantId);
cargarPedidoPendiente();
// Actualizar estado de la mesa en UI
actualizarEstadoMesaUI();
}

function volverAMesas() {
document.getElementById('view-mesas').classList.remove('hidden');
document.getElementById('view-pedido').classList.add('hidden');
document.getElementById('view-cierre').classList.add('hidden');
}

function mostrarCierreCaja() {
document.getElementById('view-mesas').classList.add('hidden');
document.getElementById('view-pedido').classList.add('hidden');
document.getElementById('view-cierre').classList.remove('hidden');
}

// Funciones auxiliares para el men√∫ inferior
function mostrarPedidos() {
document.getElementById('view-mesas').classList.add('hidden');
document.getElementById('view-pedido').classList.remove('hidden');
document.getElementById('view-cierre').classList.add('hidden');
}

function mostrarDj() {
alert('Funcionalidad DJ no implementada en esta vista');
}

async function cargarPedidoPendiente() {
if (!currentMesaId || !currentTenantId) return;
try {
const snapshot = await db.collection(`tenants/${currentTenantId}/pedidos`)
.where('mesaId', '==', currentMesaId)
.where('estado', '==', 'pendiente')
.limit(1)
.get();
if (!snapshot.empty) {
const doc = snapshot.docs[0];
pedidoActivo = { id: doc.id, ...doc.data() };
carritoLocal = pedidoActivo.items || [];
carritosPorMesa[currentMesaId] = [...carritoLocal];
} else {
carritoLocal = carritosPorMesa[currentMesaId] || [];
}
actualizarVistaPedido();
} catch (error) {
console.error("Error al cargar pedido pendiente:", error);
carritoLocal = carritosPorMesa[currentMesaId] || [];
actualizarVistaPedido();
}
}

function agregarAlPedido(articuloId, nombre, precio) {
const existente = carritoLocal.find(item => item.id === articuloId);
if (existente) {
existente.cantidad += 1;
} else {
carritoLocal.push({ id: articuloId, nombre, precio, cantidad: 1 });
}
carritosPorMesa[currentMesaId] = [...carritoLocal];
actualizarVistaPedido();
}

function ajustarCantidad(articuloId, delta) {
const item = carritoLocal.find(item => item.id === articuloId);
if (item) {
item.cantidad += delta;
if (item.cantidad <= 0) {
carritoLocal = carritoLocal.filter(i => i.id !== articuloId);
}
carritosPorMesa[currentMesaId] = [...carritoLocal];
actualizarVistaPedido();
}
}

function actualizarVistaPedido() {
const total = carritoLocal.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
document.getElementById('totalPedido').textContent = total.toLocaleString();
if (carritoLocal.length === 0) {
document.getElementById('pedidoAcumulado').innerHTML = '<p style="text-align: center; color: #94a3b8;">No hay art√≠culos</p>';
document.getElementById('btnPagar').disabled = true;
document.getElementById('btnRealizarPedido').disabled = false;
} else {
let html = '<div class="pedido-items">';
carritoLocal.forEach(item => {
html += `
<div class="pedido-item">
<div class="item-info">${item.nombre} x${item.cantidad}</div>
<div class="item-actions">
<button class="item-btn" onclick="ajustarCantidad('${item.id}', -1)">-</button>
<button class="item-btn" onclick="ajustarCantidad('${item.id}', 1)">+</button>
</div>
</div>`;
});
html += '</div>';
document.getElementById('pedidoAcumulado').innerHTML = html;
document.getElementById('btnRealizarPedido').disabled = pedidoActivo ? true : false;
document.getElementById('btnPagar').disabled = !pedidoActivo;
}
}

// === NUEVA FUNCI√ìN: Actualizar estado de la mesa en la UI ===
async function actualizarEstadoMesaUI() {
if (!currentMesaId || !currentTenantId) return;
try {
const mesaDoc = await db.collection(`tenants/${currentTenantId}/mesas`).doc(currentMesaId).get();
if (mesaDoc.exists) {
const estado = mesaDoc.data().estado || 'libre';
const estadoSpan = document.getElementById('mesaEstado');
estadoSpan.textContent = estado === 'libre' ? 'Libre' : estado === 'pendiente' ? 'Pendiente' : 'Pagada';
estadoSpan.className = `mesa-estado ${estado}`;
}
} catch (error) {
console.error("Error al cargar estado de la mesa:", error);
}
}

// === NUEVA FUNCI√ìN: Realizar Pedido ===
async function realizarPedido() {
if (carritoLocal.length === 0) return alert('‚ö†Ô∏è No hay art√≠culos para realizar el pedido');
if (!currentMesaId || !currentTenantId || !currentMesero) return;

try {
const total = carritoLocal.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
const pedidoData = {
mesaId: currentMesaId,
mesaNumero: currentMesaNumero,
meseroId: currentMesero.id,
meseroNombre: currentMesero.nombre,
items: [...carritoLocal],
total: total,
estado: 'pendiente',
createdAt: firebase.firestore.FieldValue.serverTimestamp()
};

let docRef;
let snapshot = await db.collection(`tenants/${currentTenantId}/pedidos`)
.where('mesaId', '==', currentMesaId)
.where('estado', '==', 'pendiente')
.limit(1)
.get();

if (snapshot.empty) {
docRef = await db.collection(`tenants/${currentTenantId}/pedidos`).add(pedidoData);
} else {
docRef = snapshot.docs[0].ref;
await docRef.update(pedidoData);
}

// Actualizar estado de la mesa a 'pendiente'
await db.collection(`tenants/${currentTenantId}/mesas`).doc(currentMesaId).update({ estado: 'pendiente' });

pedidoActivo = { id: docRef.id, ...carritoLocal };
carritosPorMesa[currentMesaId] = [...carritoLocal];

alert('‚úÖ Pedido realizado. La mesa est√° ahora en estado "Pendiente"');
actualizarVistaPedido();
actualizarEstadoMesaUI();
} catch (error) {
console.error("Error al realizar pedido:", error);
alert('‚ùå Error al realizar el pedido: ' + error.message);
}
}

// === FUNCI√ìN MODIFICADA: Procesar Pago ===
async function procesarPagoActual() {
if (!pedidoActivo) {
return alert('‚ö†Ô∏è Primero debes realizar el pedido antes de pagar.');
}
if (carritoLocal.length === 0) return alert('‚ö†Ô∏è No hay art√≠culos para pagar');
const formaPago = document.getElementById('formaPago').value;

try {
const total = carritoLocal.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
const pedidoData = {
items: carritoLocal,
total: total,
estado: 'pagada',
formaPago: formaPago,
pagadoAt: firebase.firestore.FieldValue.serverTimestamp()
};

await db.collection(`tenants/${currentTenantId}/pedidos`).doc(pedidoActivo.id).update(pedidoData);

// NO actualizamos la mesa aqu√≠ ‚Üí el admin la pondr√° en 'libre' al confirmar

delete carritosPorMesa[currentMesaId];
carritoLocal = [];
pedidoActivo = null;

alert('‚úÖ Pago procesado. Esperando confirmaci√≥n del administrador.');
volverAMesas();
cargarMesas(currentTenantId);
} catch (error) {
alert('‚ùå Error al procesar pago: ' + error.message);
}
}

async function solicitarCancion() {
const cancion = document.getElementById('cancionInput').value;
const artista = document.getElementById('artistaInput').value;
if (!currentMesaId || !cancion) return alert('‚ö†Ô∏è Selecciona mesa e ingresa canci√≥n');
try {
let mesaNumero = 'Desconocida';
const mesas = await db.collection(`tenants/${currentTenantId}/mesas`).get();
mesas.forEach(doc => { if (doc.id === currentMesaId) mesaNumero = doc.data().numero; });
const peticion = {
mesa: mesaNumero,
cancion,
artista: artista || null,
mesero: currentMesero.nombre,
estado: 'pendiente',
createdAt: firebase.firestore.FieldValue.serverTimestamp()
};
await db.collection(`tenants/${currentTenantId}/peticionesCancion`).add(peticion);
document.getElementById('cancionInput').value = '';
document.getElementById('artistaInput').value = '';
alert('‚úÖ Petici√≥n enviada al DJ');
} catch (error) {
alert('‚ùå Error: ' + error.message);
}
}

async function cargarCierreCaja() {
if (!currentMesero?.id || !currentTenantId) return;
try {
const hoy = new Date();
hoy.setHours(0, 0, 0, 0);
const hoyMs = hoy.getTime();

const pedidosSnapshot = await db.collection(`tenants/${currentTenantId}/pedidos`)
.where('meseroId', '==', currentMesero.id)
.where('estado', '==', 'pagada')
.get();

let totalVendido = 0;
let mesas = new Set();
let articulos = {};
let pedidosCount = 0;
pedidosSnapshot.forEach(doc => {
const p = doc.data();
if (p.pagadoAt && p.pagadoAt.seconds * 1000 >= hoyMs) {
totalVendido += p.total || 0;
mesas.add(p.mesaId);
pedidosCount++;
(p.items || []).forEach(item => {
articulos[item.nombre] = (articulos[item.nombre] || 0) + item.cantidad;
});
}
});
document.getElementById('totalVendido').textContent = totalVendido.toLocaleString();
document.getElementById('mesasAtendidas').textContent = mesas.size;
document.getElementById('pedidosPagados').textContent = pedidosCount;
document.getElementById('articulosVendidos').textContent = Object.values(articulos).reduce((a,b) => a+b, 0);
const topArticulos = Object.entries(articulos)
.sort((a, b) => b[1] - a[1])
.slice(0, 5);
if (topArticulos.length === 0) {
document.getElementById('topArticulos').innerHTML = '<p style="text-align:center; color:#94a3b8;">No hay ventas hoy</p>';
} else {
let html = '<ul style="list-style:none; padding:0;">';
topArticulos.forEach(([nombre, cantidad]) => {
html += `<li style="padding:8px 0; border-bottom:1px solid #334155;">${nombre} ‚Ä¢ ${cantidad} veces</li>`;
});
html += '</ul>';
document.getElementById('topArticulos').innerHTML = html;
}
} catch (error) {
console.error("Error al cargar cierre de caja:", error);
document.getElementById('topArticulos').innerHTML = '<p style="text-align:center; color:#f87171;">Error al cargar datos</p>';
}
}

async function cargarMesas(tenantId) {
try {
const mesasSnapshot = await db.collection(`tenants/${tenantId}/mesas`).get();
const mesas = [];
mesasSnapshot.forEach(doc => mesas.push({ id: doc.id, ...doc.data() }));
renderMesas(mesas);
} catch (error) {
document.getElementById('gridMesas').innerHTML = `<p class="text-center text-red-500 col-span-2">Error: ${error.message}</p>`;
}
}

async function cargarArticulos(tenantId) {
try {
const articulosSnapshot = await db.collection(`tenants/${tenantId}/articulos`).get();
const articulos = [];
articulosSnapshot.forEach(doc => articulos.push({ id: doc.id, ...doc.data() }));
renderMenu(articulos);
} catch (error) {
document.getElementById('menuContainer').innerHTML = `<p style="text-align: center; color: #f87171;">Error: ${error.message}</p>`;
}
}

async function init() {
try {
const data = getMeseroData();
if (!data || !data.meseroId || !data.tenantId) {
throw new Error('URL inv√°lida. Acceda desde el panel de administraci√≥n.');
}
currentMesero = { id: data.meseroId, nombre: data.meseroNombre };
currentTenantId = data.tenantId;
document.getElementById('meseroNombre').textContent = `Panel de ${currentMesero.nombre}`;
cargarMesas(currentTenantId);
} catch (error) {
document.getElementById('view-mesas').innerHTML = `
<div class="card error p-6 text-center">
<h2 class="text-red-500 mb-2">‚ùå Acceso Denegado</h2>
<p>${error.message}</p>
<button onclick="window.location.href='index.html'" class="mt-4 px-4 py-2 bg-primary text-white rounded-lg">Volver al Login</button>
</div>
`;
}
}

// === FUNCIONES PARA C√ìDIGO QR DE PAGO ===
async function cargarQrDesdeAdmin() {
if (!currentTenantId) return;
  
try {
const qrDoc = await db.collection('tenants').doc(currentTenantId).collection('configuracion').doc('qrPago').get();
const img = document.getElementById('qrPagoMesero');
const placeholder = document.getElementById('qrPlaceholderMesero');
const contenedor = document.getElementById('contenedorQr');
    
if (qrDoc.exists && qrDoc.data().base64String) {
const mimeType = qrDoc.data().mimeType || 'image/png';
img.src = `${mimeType};base64,${qrDoc.data().base64String}`;
img.style.display = 'block';
placeholder.style.display = 'none';
contenedor.style.display = 'block';
} else {
contenedor.style.display = 'none';
}
} catch (error) {
console.error('Error al cargar QR en mesero:', error);
document.getElementById('contenedorQr').style.display = 'none';
}
}

// Mostrar QR solo para Nequi o Daviplata
document.getElementById('formaPago').addEventListener('change', async function() {
const contenedorQr = document.getElementById('contenedorQr');
  
if (this.value === 'nequi' || this.value === 'daviplata') {
contenedorQr.style.display = 'block';
if (!window.qrCargado) {
await cargarQrDesdeAdmin();
window.qrCargado = true;
}
} else {
contenedorQr.style.display = 'none';
}
});

document.addEventListener('DOMContentLoaded', init);
</script>
<!-- Footer -->
<div style="text-align: center; margin-top: 30px; padding: 15px; color: #94a3b8; font-size: 13px; background: rgba(0,0,0,0.2); border-radius: 12px;">
<img src="https://raw.githubusercontent.com/appyem/imagenesappy/refs/heads/main/ChatGPT%20Image%2030%20dic%202025%2C%2007_50_08%20p.m..png" alt="AppyEmpresa S.A.S" style="width: 30px; height: 30px; object-fit: contain; vertical-align: middle; margin-right: 6px;">
Desarrollado por AppyEmpresa S.A.S
</div>
</body>
</html>

