<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel de Mesero</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
    body { background: #0f172a; color: #e2e8f0; min-height: 100vh; padding: 16px; }
    .container { max-width: 1200px; margin: 0 auto; }
    .header { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); color: white; padding: 20px; border-radius: 16px; margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; }
    .header h1 { font-size: 24px; font-weight: 700; }
    .header p { font-size: 14px; opacity: 0.8; }
    .btn { padding: 10px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; font-size: 16px; }
    .btn-primary { background: #3b82f6; color: white; }
    .btn-secondary { background: #334155; color: #cbd5e1; }
    .btn-success { background: #10b981; color: white; width: 100%; margin-top: 16px; padding: 14px; font-size: 18px; }
    .card { background: #1e293b; border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    .error { text-align: center; padding: 40px; color: #f87171; }
    
    /* Mesas */
    .zonas-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-top: 16px; }
    .zona-card { background: #334155; border-radius: 12px; padding: 16px; }
    .zona-title { font-weight: 700; margin-bottom: 12px; color: #60a5fa; }
    .mesa-item { padding: 14px; margin: 8px 0; background: #0f172a; border-radius: 10px; cursor: pointer; transition: all 0.2s; display: flex; justify-content: space-between; align-items: center; }
    .mesa-item:hover { background: #1e293b; transform: translateY(-2px); }
    .mesa-number { font-weight: 700; font-size: 18px; }
    .mesa-cap { font-size: 13px; opacity: 0.8; }
    
    /* Pedido Mesa */
    .mesa-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid #334155; }
    .mesa-title { font-size: 28px; font-weight: 800; color: #f8fafc; }
    .pedido-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; }
    @media (max-width: 768px) {
      .pedido-layout { grid-template-columns: 1fr; }
    }
    
    /* Men√∫ */
    .categorias-filtros { margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 8px; }
    .categoria-btn { padding: 6px 14px; background: #334155; color: #cbd5e1; border: none; border-radius: 20px; font-size: 14px; cursor: pointer; }
    .categoria-btn.active { background: #3b82f6; color: white; }
    .articulos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 16px; }
    .articulo-card { background: #0f172a; border-radius: 12px; padding: 16px; text-align: center; }
    .articulo-nombre { font-weight: 600; margin-bottom: 6px; font-size: 15px; }
    .articulo-precio { color: #34d399; font-weight: 700; font-size: 18px; margin-bottom: 4px; }
    .articulo-stock { font-size: 12px; color: #94a3b8; }
    .agregar-btn { background: #10b981; color: white; border: none; padding: 6px 12px; border-radius: 6px; margin-top: 8px; cursor: pointer; width: 100%; font-weight: 600; }
    
    /* Pedido acumulado */
    .pedido-items { margin-bottom: 20px; max-height: 400px; overflow-y: auto; }
    .pedido-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #334155; }
    .item-info { font-weight: 600; }
    .item-actions { display: flex; gap: 8px; }
    .item-btn { width: 28px; height: 28px; border-radius: 50%; background: #334155; color: white; border: none; font-weight: bold; cursor: pointer; }
    .pedido-total { font-size: 24px; font-weight: 800; text-align: right; margin: 20px 0; color: #34d399; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1 id="meseroNombre">Cargando Panel...</h1>
        <p id="tenantInfo">Verificando acceso...</p>
      </div>
      <button id="btnVolver" class="btn btn-secondary" style="display:none;" onclick="volverAMesas()">‚Üê Mesas</button>
    </div>

    <!-- Vista: Selecci√≥n de Mesas -->
    <div id="view-mesas">
      <div class="card">
        <h2 style="margin-bottom: 20px; color: #f8fafc;">ü™ë Selecciona una Mesa</h2>
        <div id="mesasContainer">
          <p style="text-align: center; color: #94a3b8;">Cargando mesas...</p>
        </div>
      </div>
    </div>

    <!-- Vista: Pedido de Mesa -->
    <div id="view-pedido" style="display:none;">
      <div class="mesa-header">
        <div class="mesa-title">Mesa <span id="mesaNumero">?</span></div>
        <div>Estado: <span id="mesaEstado" style="color: #fbbf24;">Pendiente</span></div>
      </div>
      
      <div class="pedido-layout">
        <!-- Men√∫ -->
        <div class="card">
          <h3 style="margin-bottom: 20px; color: #f8fafc;">üç∑ Men√∫</h3>
          <div id="menuContainer">
            <p style="text-align: center; color: #94a3b8;">Cargando men√∫...</p>
          </div>
        </div>
        
        <!-- Pedido Acumulado -->
        <div class="card">
          <h3 style="margin-bottom: 20px; color: #f8fafc;">üõí Pedido Actual</h3>
          <div id="pedidoAcumulado">
            <p style="text-align: center; color: #94a3b8;">No hay art√≠culos</p>
          </div>
          <div class="pedido-total">Total: $<span id="totalPedido">0</span></div>
          <button id="btnPagar" class="btn btn-success" onclick="procesarPagoActual()">‚úÖ Pagar Pedido</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    // === CONFIGURACI√ìN EXACTAMENTE IGUAL (no se toca) ===
    const firebaseConfig = {
      apiKey: "AIzaSyCYuZRqdrR4ZcQ97T6lU8vIqFw58cSM4hA",
      authDomain: "manager-pro-ec292.firebaseapp.com",
      projectId: "manager-pro-ec292",
      storageBucket: "manager-pro-ec292.firebasestorage.app",
      messagingSenderId: "1077289364014",
      appId: "1:1077289364014:web:a6bcea3c7ea2923ad4cdbf"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let currentMesero = null;
    let currentTenantId = null;
    let currentMesaId = null;
    let currentMesaNumero = null;
    let pedidoActivo = null; // Pedido pendiente actual para esta mesa
    let carritoLocal = []; // Art√≠culos acumulados en memoria

    // === FUNCIONES EXISTENTES SIN CAMBIOS ===
    function getMeseroData() {
      const params = new URLSearchParams(window.location.search);
      const dataParam = params.get('data');
      if (!dataParam) return null;
      try {
        const decoded = decodeURIComponent(dataParam);
        const jsonStr = atob(decoded);
        return JSON.parse(jsonStr);
      } catch (e) {
        console.error('Error al decodificar datos:', e);
        return null;
      }
    }

    function renderMesas(mesas) {
      const zonas = ['Terraza', 'Bar Principal', 'Zona VIP', 'Pista de Baile'];
      let html = '';
      zonas.forEach(zona => {
        const mesasZona = mesas.filter(m => m.ubicacion === zona);
        if (mesasZona.length > 0) {
          html += `<div class="zona-card"><div class="zona-title">${zona}</div>`;
          mesasZona.forEach(mesa => {
            html += `<div class="mesa-item" onclick="seleccionarMesa('${mesa.id}', '${mesa.numero}')">
              <div>
                <div class="mesa-number">Mesa ${mesa.numero}</div>
                <div class="mesa-cap">Cap: ${mesa.capacidad}</div>
              </div>
              <div style="text-align: right; font-weight: bold; color: ${mesa.estado === 'pendiente' ? '#fbbf24' : mesa.estado === 'pagada' ? '#34d399' : '#94a3b8'}">
                ${mesa.estado === 'libre' ? 'Libre' : mesa.estado === 'pendiente' ? '‚è≥' : '‚úÖ'}
              </div>
            </div>`;
          });
          html += '</div>';
        }
      });
      document.getElementById('mesasContainer').innerHTML = html || '<p style="text-align: center; color: #94a3b8;">No hay mesas disponibles</p>';
    }

    function renderMenu(articulos) {
      const categorias = [...new Set(articulos.map(a => a.categoria).filter(c => c))];
      let html = '<div class="categorias-filtros"><button class="categoria-btn active" onclick="filtrarCategoria(\'all\')">Todos</button>';
      categorias.forEach(cat => {
        html += `<button class="categoria-btn" onclick="filtrarCategoria('${cat}')">${cat}</button>`;
      });
      html += '</div><div class="articulos-grid">';
      articulos.forEach(art => {
        html += `<div class="articulo-card">
          <div class="articulo-nombre">${art.nombre}</div>
          <div class="articulo-precio">$${art.precio.toLocaleString()}</div>
          <div class="articulo-stock">Stock: ${art.stock}</div>
          <button class="agregar-btn" onclick="agregarAlPedido('${art.id}', '${art.nombre}', ${art.precio})">+</button>
        </div>`;
      });
      html += '</div>';
      document.getElementById('menuContainer').innerHTML = html;
    }

    function filtrarCategoria(categoria) {
      document.querySelectorAll('.categoria-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
    }

    // === NUEVAS FUNCIONES DE FLUJO (sin tocar l√≥gica de Firestore) ===
    function seleccionarMesa(mesaId, mesaNumero) {
      currentMesaId = mesaId;
      currentMesaNumero = mesaNumero;
      document.getElementById('mesaNumero').textContent = mesaNumero;
      document.getElementById('view-mesas').style.display = 'none';
      document.getElementById('view-pedido').style.display = 'block';
      document.getElementById('btnVolver').style.display = 'inline-block';
      
      // Cargar men√∫ y pedido pendiente (si existe)
      cargarArticulos(currentTenantId);
      cargarPedidoPendiente();
    }

    function volverAMesas() {
      document.getElementById('view-mesas').style.display = 'block';
      document.getElementById('view-pedido').style.display = 'none';
      document.getElementById('btnVolver').style.display = 'none';
      carritoLocal = [];
    }

    async function cargarPedidoPendiente() {
      if (!currentMesaId || !currentTenantId) return;
      
      try {
        const snapshot = await db.collection(`tenants/${currentTenantId}/pedidos`)
          .where('mesaId', '==', currentMesaId)
          .where('estado', '==', 'pendiente')
          .limit(1)
          .get();
        
        if (!snapshot.empty) {
          const doc = snapshot.docs[0];
          pedidoActivo = { id: doc.id, ...doc.data() };
          carritoLocal = pedidoActivo.items || [];
        } else {
          pedidoActivo = null;
          carritoLocal = [];
        }
        actualizarVistaPedido();
      } catch (error) {
        console.error("Error al cargar pedido pendiente:", error);
      }
    }

    function agregarAlPedido(articuloId, nombre, precio) {
      // Buscar si ya existe
      const existente = carritoLocal.find(item => item.id === articuloId);
      if (existente) {
        existente.cantidad += 1;
      } else {
        carritoLocal.push({ id: articuloId, nombre, precio, cantidad: 1 });
      }
      actualizarVistaPedido();
    }

    function ajustarCantidad(articuloId, delta) {
      const item = carritoLocal.find(item => item.id === articuloId);
      if (item) {
        item.cantidad += delta;
        if (item.cantidad <= 0) {
          carritoLocal = carritoLocal.filter(i => i.id !== articuloId);
        }
        actualizarVistaPedido();
      }
    }

    function actualizarVistaPedido() {
      const total = carritoLocal.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
      document.getElementById('totalPedido').textContent = total.toLocaleString();
      
      if (carritoLocal.length === 0) {
        document.getElementById('pedidoAcumulado').innerHTML = '<p style="text-align: center; color: #94a3b8;">No hay art√≠culos</p>';
        document.getElementById('btnPagar').disabled = true;
      } else {
        let html = '<div class="pedido-items">';
        carritoLocal.forEach(item => {
          html += `
            <div class="pedido-item">
              <div class="item-info">${item.nombre} x${item.cantidad}</div>
              <div class="item-actions">
                <button class="item-btn" onclick="ajustarCantidad('${item.id}', -1)">-</button>
                <button class="item-btn" onclick="ajustarCantidad('${item.id}', 1)">+</button>
              </div>
            </div>`;
        });
        html += '</div>';
        document.getElementById('pedidoAcumulado').innerHTML = html;
        document.getElementById('btnPagar').disabled = false;
      }
    }

    async function procesarPagoActual() {
      if (carritoLocal.length === 0) return alert('‚ö†Ô∏è No hay art√≠culos para pagar');
      
      try {
        const total = carritoLocal.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
        let pedidoData = {
          mesaId: currentMesaId,
          mesaNumero: currentMesaNumero,
          meseroId: currentMesero.id,
          meseroNombre: currentMesero.nombre,
          items: carritoLocal,
          total: total,
          estado: 'pagada',
          formaPago: 'efectivo',
          pagadoAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        if (pedidoActivo) {
          // Actualizar pedido existente
          await db.collection(`tenants/${currentTenantId}/pedidos`).doc(pedidoActivo.id).update(pedidoData);
        } else {
          // Crear nuevo pedido
          pedidoData.estado = 'pendiente'; // Primero se crea como pendiente
          const docRef = await db.collection(`tenants/${currentTenantId}/pedidos`).add(pedidoData);
          // Luego se actualiza a pagada
          await db.collection(`tenants/${currentTenantId}/pedidos`).doc(docRef.id).update({ estado: 'pagada' });
        }

        // Marcar mesa como pagada
        await db.collection(`tenants/${currentTenantId}/mesas`).doc(currentMesaId).update({ estado: 'pagada' });

        alert('‚úÖ Pago procesado exitosamente');
        volverAMesas();
        cargarMesas(currentTenantId); // Refrescar estado de mesas
      } catch (error) {
        alert('‚ùå Error al procesar pago: ' + error.message);
      }
    }

    // === FUNCIONES EXISTENTES SIN CAMBIOS ===
    async function cargarMesas(tenantId) {
      try {
        const mesasSnapshot = await db.collection(`tenants/${tenantId}/mesas`).get();
        const mesas = [];
        mesasSnapshot.forEach(doc => mesas.push({ id: doc.id, ...doc.data() }));
        renderMesas(mesas);
      } catch (error) {
        document.getElementById('mesasContainer').innerHTML = `<p style="text-align: center; color: #f87171;">Error: ${error.message}</p>`;
      }
    }

    async function cargarArticulos(tenantId) {
      try {
        const articulosSnapshot = await db.collection(`tenants/${tenantId}/articulos`).get();
        const articulos = [];
        articulosSnapshot.forEach(doc => articulos.push({ id: doc.id, ...doc.data() }));
        renderMenu(articulos);
      } catch (error) {
        document.getElementById('menuContainer').innerHTML = `<p style="text-align: center; color: #f87171;">Error: ${error.message}</p>`;
      }
    }

    // === INICIALIZACI√ìN ===
    async function init() {
      try {
        const data = getMeseroData();
        if (!data || !data.meseroId || !data.tenantId) {
          throw new Error('URL inv√°lida. Acceda desde el panel de administraci√≥n.');
        }
        currentMesero = { id: data.meseroId, nombre: data.meseroNombre };
        currentTenantId = data.tenantId;
        document.getElementById('meseroNombre').textContent = `Panel de ${currentMesero.nombre}`;
        document.getElementById('tenantInfo').textContent = `Tenant: ${currentTenantId.substring(0, 8)}...`;
        cargarMesas(currentTenantId);
      } catch (error) {
        document.getElementById('view-mesas').innerHTML = `
          <div class="card error">
            <h2>‚ùå Acceso Denegado</h2>
            <p>${error.message}</p>
            <button onclick="window.location.href='index.html'" class="btn btn-primary" style="margin-top: 20px;">
              Volver al Login
            </button>
          </div>
        `;
      }
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>

