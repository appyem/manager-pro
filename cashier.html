<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Panel de Mesero</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700&family=Cormorant+Garamond:wght@600;700&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
body {
  background: #1A1D21 url('https://raw.githubusercontent.com/appyem/imagens-manager-pro/refs/heads/main/ChatGPT%20Image%208%20ene%202026%2C%2004_10_16%20p.m..png') center/cover fixed;
  color: #FFFFFF;
  min-height: 100vh;
  padding: 16px;
  backdrop-filter: blur(2px);
}
.container { max-width: 1200px; margin: 0 auto; }
.header {
  background: rgba(255, 255, 255, 0.15);
  backdrop-filter: blur(12px);
  color: white;
  padding: 20px;
  border-radius: 16px;
  margin-bottom: 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 8px 20px rgba(199, 121, 78, 0.2);
  border: 1px solid rgba(255, 255, 255, 0.1);
}
h1, h2, h3, .mesa-title, .stat-value, .pedido-total {
font-family: 'Barlow Condensed', sans-serif;
font-weight: 700;
}
.header h1 { font-size: 24px; font-weight: 700; }
.header p { font-size: 14px; opacity: 0.9; }
.btn {
padding: 10px 16px;
border-radius: 10px;
font-weight: 600;
cursor: pointer;
border: none;
font-size: 16px;
transition: all 0.2s;
}
.btn-primary {
background: #C7794E;
color: white;
}
.btn-secondary {
background: rgba(199, 121, 78, 0.2);
color: #F0E6D2;
}
.btn-success {
background: linear-gradient(135deg, #C7794E 0%, #A65A3B 100%);
color: white;
width: 100%;
margin-top: 16px;
padding: 14px;
font-size: 18px;
border-radius: 12px;
box-shadow: 0 4px 12px rgba(199, 121, 78, 0.3);
}
.card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(12px);
  border-radius: 16px;
  padding: 24px;
  margin-bottom: 24px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
  border: 1px solid rgba(255, 255, 255, 0.1);
}
.error { text-align: center; padding: 40px; color: #f87171; }
/* Mesas */
.zonas-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-top: 16px; }
.zona-card {
  background: rgba(255, 255, 255, 0.06);
  backdrop-filter: blur(10px);
  border-radius: 12px;
  padding: 16px;
  border: 1px solid rgba(255, 255, 255, 0.1);
}
.mesa-item {
  padding: 14px;
  margin: 8px 0;
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(8px);
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.3s;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border: 2px solid transparent;
}
.mesa-item:hover {
  background: rgba(255, 255, 255, 0.1);
  transform: translateY(-3px);
  border-color: #C7794E;
}
.mesa-number {
  font-weight: 700;
  font-size: 18px;
  color: #FFFFFF;
  background: rgba(0, 0, 0, 0.4);
  padding: 6px 12px;
  border-radius: 8px;
  display: inline-block;
  margin-bottom: 4px;
  text-align: center;
  width: calc(100% - 24px);
  box-sizing: border-box;
}
.mesa-cap { font-size: 13px; opacity: 0.8; }
/* Pedido Mesa */
.mesa-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 24px;
padding-bottom: 16px;
border-bottom: 1px solid #334155;
}
.mesa-title { font-size: 28px; font-weight: 800; color: #F0E6D2; }
.pedido-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; }
@media (max-width: 768px) {
.pedido-layout { grid-template-columns: 1fr; }
}
/* Men√∫ */
.categorias-filtros { margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 8px; }
.categoria-btn {
padding: 6px 14px;
background: rgba(51, 65, 85, 0.8);
color: #cbd5e1;
border: none;
border-radius: 20px;
font-size: 14px;
cursor: pointer;
}
.categoria-btn.active {
background: #C7794E;
color: white;
}
.articulos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 16px; }
.articulo-card {
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(8px);
  border-radius: 12px;
  padding: 16px;
  text-align: center;
  transition: transform 0.2s;
  border: 1px solid rgba(255, 255, 255, 0.08);
}
.articulo-card:hover {
  transform: scale(1.03);
  background: rgba(255, 255, 255, 0.08);
}
.articulo-card:hover {
transform: scale(1.03);
}
.articulo-nombre {
  font-weight: 700;
  font-size: 15px;
  color: #FFFFFF;
  background: rgba(0, 0, 0, 0.4);
  padding: 6px 12px;
  border-radius: 8px;
  display: inline-block;
  margin: 0 auto 8px;
  text-align: center;
  width: calc(100% - 24px);
  box-sizing: border-box;
}
.articulo-precio { color: #8A9B68; font-weight: 700; font-size: 18px; margin-bottom: 4px; }
.articulo-stock { font-size: 12px; color: #94a3b8; }
.agregar-btn {
background: linear-gradient(135deg, #8A9B68 0%, #6B7B54 100%);
color: #1A1D21;
border: none;
padding: 6px 12px;
border-radius: 6px;
margin-top: 8px;
cursor: pointer;
width: 100%;
font-weight: 600;
}
/* Pedido acumulado */
.pedido-items { margin-bottom: 20px; max-height: 400px; overflow-y: auto; }
.pedido-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #334155; }
.item-info { font-weight: 600; }
.item-actions { display: flex; gap: 8px; }
.item-btn {
width: 28px;
height: 28px;
border-radius: 50%;
background: #334155;
color: white;
border: none;
font-weight: bold;
cursor: pointer;
}
.pedido-total {
font-size: 24px;
font-weight: 800;
text-align: right;
margin: 20px 0;
color: #8A9B68;
}
/* Cierre de Caja */
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin: 20px 0; }
.stat-card { background: rgba(51, 65, 85, 0.6); padding: 16px; border-radius: 12px; text-align: center; }
.stat-value { font-size: 22px; font-weight: 700; margin: 8px 0; color: #C7794E; }
.stat-label { font-size: 13px; opacity: 0.8; }
/* DJ */
.dj-section { margin-top: 30px; padding-top: 20px; border-top: 1px solid #334155; }
.dj-btn {
background: linear-gradient(135deg, #8A9B68 0%, #C7794E 100%);
color: white;
padding: 12px;
border: none;
border-radius: 10px;
font-weight: 600;
width: 100%;
margin-top: 16px;
cursor: pointer;
}
/* Estados de mesas */
.mesa-estado.libre, .table-status.libre {
background: #2F5D51;
color: #F0E6D2;
}
.mesa-estado.pendiente, .table-status.pendiente {
background: #C7794E;
color: #1A1D21;
}
.mesa-estado.pagada, .table-status.pagada {
background: #8A9B68;
color: #1A1D21;
}

/* === ICONO DE MESA PERSONALIZADO === */
.mesa-icono {
  width: 32px;
  height: 32px;
  margin-right: 8px;
  vertical-align: middle;
}
.mesa-info {
  display: flex;
  align-items: center;
  font-weight: 700;
  font-size: 18px;
  color: #FFFFFF;
}

</style>
</head>
<body>
<div class="container">
<div class="header">
<div>
<div style="display: flex; align-items: center; gap: 12px;">
<img src="https://raw.githubusercontent.com/appyem/imagenesappy/refs/heads/main/ChatGPT%20Image%206%20ene%202026%2C%2006_33_51%20p.m..png" alt="AppyEmpresa S.A.S" style="width: 32px; height: 32px; object-fit: contain;">
<span id="meseroNombre" style="font-family: 'Cormorant Garamond', serif; font-weight: 700; font-size: 22px; color: #FFFFFF;">Cargando Panel...</span>
</div>
<!-- Eliminamos completamente el p√°rrafo del tenant ID -->
</div>
<button id="btnCierreCaja" class="btn btn-secondary" onclick="mostrarCierreCaja()">
  <img src="https://raw.githubusercontent.com/appyem/imagens-manager-pro/refs/heads/main/ciere%20de%20caja.png" alt="Cierre de Caja" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px;">
  Cierre de Caja
</button>
<button id="btnVolver" class="btn btn-secondary" style="display:none;" onclick="volverAMesas()">‚Üê Mesas</button>
</div>
<!-- Vista: Selecci√≥n de Mesas -->
<div id="view-mesas">
<div class="card">
<h2 style="margin-bottom: 20px; color: #F0E6D2;">
  <img src="https://raw.githubusercontent.com/appyem/imagens-manager-pro/refs/heads/main/icono%20mesa%202.png" alt="Mesa" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;">
  Selecciona una Mesa
</h2>
<div id="mesasContainer">
<p style="text-align: center; color: #94a3b8;">Cargando mesas...</p>
</div>
</div>
</div>
<!-- Vista: Pedido de Mesa -->
<div id="view-pedido" style="display:none;">
<div class="mesa-header">
<div class="mesa-title">Mesa <span id="mesaNumero">?</span></div>
<div>Estado: <span id="mesaEstado" class="mesa-estado pendiente">Cargando...</span></div>
</div>
<div class="pedido-layout">
<!-- Men√∫ + DJ -->
<div class="card">
<h3 style="margin-bottom: 20px; color: #F0E6D2;">üç∑ Men√∫</h3>
<div id="menuContainer">
<p style="text-align: center; color: #94a3b8;">Cargando men√∫...</p>
</div>
<!-- DJ -->
<div class="dj-section">
<h3 style="color: #F0E6D2; margin-bottom: 12px;">üéµ Pedir Canci√≥n al DJ</h3>
<div class="form-group">
<input type="text" id="cancionInput" placeholder="Nombre de la canci√≥n" style="width:100%; padding:10px; border-radius:8px; margin-bottom:8px; background:rgba(0,0,0,0.3); color:#F0E6D2; border:1px solid #334155;">
</div>
<div class="form-group">
<input type="text" id="artistaInput" placeholder="Artista (opcional)" style="width:100%; padding:10px; border-radius:8px; background:rgba(0,0,0,0.3); color:#F0E6D2; border:1px solid #334155;">
</div>
<button class="dj-btn" onclick="solicitarCancion()">Enviar al DJ</button>
</div>
</div>
<!-- Pedido Acumulado -->
<div class="card">
<h3 style="margin-bottom: 20px; color: #F0E6D2;">üõí Pedido Actual</h3>
<div id="pedidoAcumulado">
<p style="text-align: center; color: #94a3b8;">No hay art√≠culos</p>
</div>
<div class="pedido-total">Total: $<span id="totalPedido">0</span></div>
<div class="form-group" style="margin: 20px 0;">
<label style="display:block; margin-bottom:8px; color:#cbd5e1;">Forma de Pago</label>
<select id="formaPago" style="width:100%; padding:12px; border-radius:8px; background:rgba(0,0,0,0.3); color:#F0E6D2; border:1px solid #334155;">
<option value="efectivo">Efectivo</option>
<option value="tarjeta">Tarjeta</option>
<option value="nequi">Nequi</option>
<option value="daviplata">Daviplata</option>
</select>
</div>
<div id="contenedorQr" style="text-align: center; margin: 20px 0; display: none;">
  <div style="width: 200px; height: 200px; margin: 0 auto; border: 2px dashed #334155; border-radius: 12px; background: #0f172a; display: flex; align-items: center; justify-content: center;">
    <img id="qrPagoMesero" src="" alt="C√≥digo QR de Pago" style="max-width: 100%; max-height: 100%; object-fit: contain; display: none;">
    <span id="qrPlaceholderMesero" style="color: #94a3b8; font-size: 14px;">Cargando c√≥digo QR...</span>
  </div>
</div>
<button id="btnRealizarPedido" class="btn btn-secondary" style="margin-bottom:12px; width:100%;" onclick="realizarPedido()">üì§ Realizar Pedido</button>
<button id="btnPagar" class="btn btn-success" onclick="procesarPagoActual()" disabled>‚úÖ Pagar Pedido</button>
</div>
</div>
</div>
<!-- Vista: Cierre de Caja -->
<div id="view-cierre" style="display:none;">
<div class="card">
<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
<h2 style="color:#F0E6D2;">
  <img src="https://raw.githubusercontent.com/appyem/imagens-manager-pro/refs/heads/main/ciere%20de%20caja.png" alt="Cierre de Caja" style="width: 24px; height: 24px; vertical-align: middle; margin-right: 8px;">
  Cierre de Caja - Hoy
</h2>
<button class="btn btn-secondary" onclick="volverAMesas()">‚Üê Volver</button>
</div>
<div class="stats-grid">
<div class="stat-card">
<div class="stat-label">Total Vendido</div>
<div class="stat-value">$<span id="totalVendido">0</span></div>
</div>
<div class="stat-card">
<div class="stat-label">Mesas Atendidas</div>
<div class="stat-value"><span id="mesasAtendidas">0</span></div>
</div>
<div class="stat-card">
<div class="stat-label">Pedidos Pagados</div>
<div class="stat-value"><span id="pedidosPagados">0</span></div>
</div>
<div class="stat-card">
<div class="stat-label">Art√≠culos Vendidos</div>
<div class="stat-value"><span id="articulosVendidos">0</span></div>
</div>
</div>
<h3 style="color:#F0E6D2; margin:20px 0;">Top Art√≠culos Vendidos</h3>
<div id="topArticulos">
<p style="text-align:center; color:#94a3b8;">No hay ventas hoy</p>
</div>
</div>
</div>
</div>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script>
// === CONFIGURACI√ìN EXACTAMENTE IGUAL ===
const firebaseConfig = {
apiKey: "AIzaSyCYuZRqdrR4ZcQ97T6lU8vIqFw58cSM4hA",
authDomain: "manager-pro-ec292.firebaseapp.com",
projectId: "manager-pro-ec292",
storageBucket: "manager-pro-ec292.firebasestorage.app",
messagingSenderId: "1077289364014",
appId: "1:1077289364014:web:a6bcea3c7ea2923ad4cdbf"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
let currentMesero = null;
let currentTenantId = null;
let currentMesaId = null;
let currentMesaNumero = null;
let pedidoActivo = null;
const carritosPorMesa = {};
let carritoLocal = [];

// === FUNCIONES EXISTENTES SIN CAMBIOS ===
function getMeseroData() {
const params = new URLSearchParams(window.location.search);
const dataParam = params.get('data');
if (!dataParam) return null;
try {
const decoded = decodeURIComponent(dataParam);
const jsonStr = atob(decoded);
return JSON.parse(jsonStr);
} catch (e) {
console.error('Error al decodificar datos:', e);
return null;
}
}
function renderMesas(mesas) {
  const zonas = ['Terraza', 'Bar Principal', 'Zona VIP', 'Pista de Baile'];
  let html = '';
  zonas.forEach(zona => {
    const mesasZona = mesas.filter(m => m.ubicacion === zona);
    if (mesasZona.length > 0) {
      html += `<div class="zona-card"><div class="zona-title">${zona}</div>`;
      mesasZona.forEach(mesa => {
        const estadoClass = mesa.estado === 'libre' ? 'libre' : mesa.estado === 'pendiente' ? 'pendiente' : 'pagada';
        html += `<div class="mesa-item" onclick="seleccionarMesa('${mesa.id}', '${mesa.numero}')">
          <div>
            <div class="mesa-info">
              <img src="https://raw.githubusercontent.com/appyem/imagens-manager-pro/refs/heads/main/icono%20mesa%202.png" alt="Mesa" class="mesa-icono">
              ${mesa.numero}
            </div>
            <div class="mesa-cap">Cap: ${mesa.capacidad}</div>
          </div>
          <div style="text-align: right; font-weight: bold;">
            <span class="mesa-estado ${estadoClass}">
              ${mesa.estado === 'libre' ? 'Libre' : mesa.estado === 'pendiente' ? 'Pendiente' : 'Pagada'}
            </span>
          </div>
        </div>`;
      });
      html += '</div>';
    }
  });
  document.getElementById('mesasContainer').innerHTML = html || '<p style="text-align: center; color: #94a3b8;">No hay mesas disponibles</p>';
}
function renderMenu(articulos) {
const categorias = [...new Set(articulos.map(a => a.categoria).filter(c => c))];
let html = '<div class="categorias-filtros"><button class="categoria-btn active" onclick="filtrarCategoria(\'all\')">Todos</button>';
categorias.forEach(cat => {
html += `<button class="categoria-btn" onclick="filtrarCategoria('${cat}')">${cat}</button>`;
});
html += '</div><div class="articulos-grid">';
articulos.forEach(art => {
html += `<div class="articulo-card">
<div class="articulo-nombre">${art.nombre}</div>
<div class="articulo-precio">$${art.precio.toLocaleString()}</div>
<div class="articulo-stock">Stock: ${art.stock}</div>
<button class="agregar-btn" onclick="agregarAlPedido('${art.id}', '${art.nombre}', ${art.precio})">+</button>
</div>`;
});
html += '</div>';
document.getElementById('menuContainer').innerHTML = html;
}
// Variable global para almacenar todos los art√≠culos
let articulosOriginales = [];

// Modificar la funci√≥n renderMenu para guardar los art√≠culos originales
function renderMenu(articulos) {
  articulosOriginales = articulos; // Guardar copia original
  
  const categorias = [...new Set(articulos.map(a => a.categoria).filter(c => c))];
  let html = '<div class="categorias-filtros"><button class="categoria-btn active" onclick="filtrarCategoria(\'all\')">Todos</button>';
  categorias.forEach(cat => {
    html += `<button class="categoria-btn" onclick="filtrarCategoria('${cat}')">${cat}</button>`;
  });
  html += '</div><div class="articulos-grid" id="articulosGrid">';
  
  // Renderizar todos los art√≠culos inicialmente
  articulos.forEach(art => {
    html += `<div class="articulo-card">
      <div class="articulo-nombre">${art.nombre}</div>
      <div class="articulo-precio">$${art.precio.toLocaleString()}</div>
      <div class="articulo-stock">Stock: ${art.stock}</div>
      <button class="agregar-btn" onclick="agregarAlPedido('${art.id}', '${art.nombre}', ${art.precio})">+</button>
    </div>`;
  });
  html += '</div>';
  document.getElementById('menuContainer').innerHTML = html;
}

// Nueva funci√≥n de filtrado
function filtrarCategoria(categoria) {
  // Actualizar botones activos
  document.querySelectorAll('.categoria-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  
  // Filtrar art√≠culos
  let articulosFiltrados;
  if (categoria === 'all') {
    articulosFiltrados = articulosOriginales;
  } else {
    articulosFiltrados = articulosOriginales.filter(art => art.categoria === categoria);
  }
  
  // Re-renderizar solo los art√≠culos filtrados
  const grid = document.getElementById('articulosGrid');
  if (!grid) return;
  
  let html = '';
  articulosFiltrados.forEach(art => {
    html += `<div class="articulo-card">
      <div class="articulo-nombre">${art.nombre}</div>
      <div class="articulo-precio">$${art.precio.toLocaleString()}</div>
      <div class="articulo-stock">Stock: ${art.stock}</div>
      <button class="agregar-btn" onclick="agregarAlPedido('${art.id}', '${art.nombre}', ${art.precio})">+</button>
    </div>`;
  });
  grid.innerHTML = html;
}

function seleccionarMesa(mesaId, mesaNumero) {
if (currentMesaId) {
carritosPorMesa[currentMesaId] = carritoLocal;
}
currentMesaId = mesaId;
currentMesaNumero = mesaNumero;
carritoLocal = carritosPorMesa[mesaId] || [];
document.getElementById('mesaNumero').textContent = mesaNumero;
document.getElementById('view-mesas').style.display = 'none';
document.getElementById('view-pedido').style.display = 'block';
document.getElementById('btnVolver').style.display = 'inline-block';
document.getElementById('btnCierreCaja').style.display = 'none';
cargarArticulos(currentTenantId);
cargarPedidoPendiente();
// Actualizar estado de la mesa en UI
actualizarEstadoMesaUI();
}
function volverAMesas() {
document.getElementById('view-mesas').style.display = 'block';
document.getElementById('view-pedido').style.display = 'none';
document.getElementById('view-cierre').style.display = 'none';
document.getElementById('btnVolver').style.display = 'none';
document.getElementById('btnCierreCaja').style.display = 'inline-block';
}
async function cargarPedidoPendiente() {
if (!currentMesaId || !currentTenantId) return;
try {
const snapshot = await db.collection(`tenants/${currentTenantId}/pedidos`)
.where('mesaId', '==', currentMesaId)
.where('estado', '==', 'pendiente')
.limit(1)
.get();
if (!snapshot.empty) {
const doc = snapshot.docs[0];
pedidoActivo = { id: doc.id, ...doc.data() };
carritoLocal = pedidoActivo.items || [];
carritosPorMesa[currentMesaId] = [...carritoLocal];
} else {
carritoLocal = carritosPorMesa[currentMesaId] || [];
}
actualizarVistaPedido();
} catch (error) {
console.error("Error al cargar pedido pendiente:", error);
carritoLocal = carritosPorMesa[currentMesaId] || [];
actualizarVistaPedido();
}
}
function agregarAlPedido(articuloId, nombre, precio) {
const existente = carritoLocal.find(item => item.id === articuloId);
if (existente) {
existente.cantidad += 1;
} else {
carritoLocal.push({ id: articuloId, nombre, precio, cantidad: 1 });
}
carritosPorMesa[currentMesaId] = [...carritoLocal];
actualizarVistaPedido();
}
function ajustarCantidad(articuloId, delta) {
const item = carritoLocal.find(item => item.id === articuloId);
if (item) {
item.cantidad += delta;
if (item.cantidad <= 0) {
carritoLocal = carritoLocal.filter(i => i.id !== articuloId);
}
carritosPorMesa[currentMesaId] = [...carritoLocal];
actualizarVistaPedido();
}
}
function actualizarVistaPedido() {
const total = carritoLocal.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
document.getElementById('totalPedido').textContent = total.toLocaleString();
if (carritoLocal.length === 0) {
document.getElementById('pedidoAcumulado').innerHTML = '<p style="text-align: center; color: #94a3b8;">No hay art√≠culos</p>';
document.getElementById('btnPagar').disabled = true;
document.getElementById('btnRealizarPedido').disabled = false;
} else {
let html = '<div class="pedido-items">';
carritoLocal.forEach(item => {
html += `
<div class="pedido-item">
<div class="item-info">${item.nombre} x${item.cantidad}</div>
<div class="item-actions">
<button class="item-btn" onclick="ajustarCantidad('${item.id}', -1)">-</button>
<button class="item-btn" onclick="ajustarCantidad('${item.id}', 1)">+</button>
</div>
</div>`;
});
html += '</div>';
document.getElementById('pedidoAcumulado').innerHTML = html;
document.getElementById('btnRealizarPedido').disabled = pedidoActivo ? true : false;
document.getElementById('btnPagar').disabled = !pedidoActivo;
}
}

// === NUEVA FUNCI√ìN: Actualizar estado de la mesa en la UI ===
async function actualizarEstadoMesaUI() {
if (!currentMesaId || !currentTenantId) return;
try {
const mesaDoc = await db.collection(`tenants/${currentTenantId}/mesas`).doc(currentMesaId).get();
if (mesaDoc.exists) {
const estado = mesaDoc.data().estado || 'libre';
const estadoSpan = document.getElementById('mesaEstado');
estadoSpan.textContent = estado === 'libre' ? 'Libre' : estado === 'pendiente' ? 'Pendiente' : 'Pagada';
estadoSpan.className = `mesa-estado ${estado}`;
}
} catch (error) {
console.error("Error al cargar estado de la mesa:", error);
}
}

// === NUEVA FUNCI√ìN: Realizar Pedido ===
async function realizarPedido() {
if (carritoLocal.length === 0) return alert('‚ö†Ô∏è No hay art√≠culos para realizar el pedido');
if (!currentMesaId || !currentTenantId || !currentMesero) return;

try {
const total = carritoLocal.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
const pedidoData = {
mesaId: currentMesaId,
mesaNumero: currentMesaNumero,
meseroId: currentMesero.id,
meseroNombre: currentMesero.nombre,
items: [...carritoLocal],
total: total,
estado: 'pendiente',
createdAt: firebase.firestore.FieldValue.serverTimestamp()
};

let docRef;
let snapshot = await db.collection(`tenants/${currentTenantId}/pedidos`)
.where('mesaId', '==', currentMesaId)
.where('estado', '==', 'pendiente')
.limit(1)
.get();

if (snapshot.empty) {
docRef = await db.collection(`tenants/${currentTenantId}/pedidos`).add(pedidoData);
} else {
docRef = snapshot.docs[0].ref;
await docRef.update(pedidoData);
}

// Actualizar estado de la mesa a 'pendiente'
await db.collection(`tenants/${currentTenantId}/mesas`).doc(currentMesaId).update({ estado: 'pendiente' });

pedidoActivo = { id: docRef.id, ...carritoLocal };
carritosPorMesa[currentMesaId] = [...carritoLocal];

alert('‚úÖ Pedido realizado. La mesa est√° ahora en estado "Pendiente"');
actualizarVistaPedido();
actualizarEstadoMesaUI();
} catch (error) {
console.error("Error al realizar pedido:", error);
alert('‚ùå Error al realizar el pedido: ' + error.message);
}
}

// === FUNCI√ìN MODIFICADA: Procesar Pago ===
async function procesarPagoActual() {
if (!pedidoActivo) {
return alert('‚ö†Ô∏è Primero debes realizar el pedido antes de pagar.');
}
if (carritoLocal.length === 0) return alert('‚ö†Ô∏è No hay art√≠culos para pagar');
const formaPago = document.getElementById('formaPago').value;

try {
const total = carritoLocal.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
const pedidoData = {
items: carritoLocal,
total: total,
estado: 'pagada',
formaPago: formaPago,
pagadoAt: firebase.firestore.FieldValue.serverTimestamp()
};

await db.collection(`tenants/${currentTenantId}/pedidos`).doc(pedidoActivo.id).update(pedidoData);

// NO actualizamos la mesa aqu√≠ ‚Üí el admin la pondr√° en 'libre' al confirmar

delete carritosPorMesa[currentMesaId];
carritoLocal = [];
pedidoActivo = null;

alert('‚úÖ Pago procesado. Esperando confirmaci√≥n del administrador.');
volverAMesas();
cargarMesas(currentTenantId);
} catch (error) {
alert('‚ùå Error al procesar pago: ' + error.message);
}
}

async function solicitarCancion() {
const cancion = document.getElementById('cancionInput').value;
const artista = document.getElementById('artistaInput').value;
if (!currentMesaId || !cancion) return alert('‚ö†Ô∏è Selecciona mesa e ingresa canci√≥n');
try {
let mesaNumero = 'Desconocida';
const mesas = await db.collection(`tenants/${currentTenantId}/mesas`).get();
mesas.forEach(doc => { if (doc.id === currentMesaId) mesaNumero = doc.data().numero; });
const peticion = {
mesa: mesaNumero,
cancion,
artista: artista || null,
mesero: currentMesero.nombre,
estado: 'pendiente',
createdAt: firebase.firestore.FieldValue.serverTimestamp()
};
await db.collection(`tenants/${currentTenantId}/peticionesCancion`).add(peticion);
document.getElementById('cancionInput').value = '';
document.getElementById('artistaInput').value = '';
alert('‚úÖ Petici√≥n enviada al DJ');
} catch (error) {
alert('‚ùå Error: ' + error.message);
}
}
function mostrarCierreCaja() {
document.getElementById('view-mesas').style.display = 'none';
document.getElementById('view-pedido').style.display = 'none';
document.getElementById('view-cierre').style.display = 'block';
document.getElementById('btnCierreCaja').style.display = 'none';
cargarCierreCaja();
}
async function cargarCierreCaja() {
if (!currentMesero?.id || !currentTenantId) return;
try {
const hoy = new Date();
hoy.setHours(0, 0, 0, 0);
const hoyMs = hoy.getTime();

const pedidosSnapshot = await db.collection(`tenants/${currentTenantId}/pedidos`)
.where('meseroId', '==', currentMesero.id)
.where('estado', '==', 'pagada')
.get();

let totalVendido = 0;
let mesas = new Set();
let articulos = {};
let pedidosCount = 0;
pedidosSnapshot.forEach(doc => {
const p = doc.data();
if (p.pagadoAt && p.pagadoAt.seconds * 1000 >= hoyMs) {
totalVendido += p.total || 0;
mesas.add(p.mesaId);
pedidosCount++;
(p.items || []).forEach(item => {
articulos[item.nombre] = (articulos[item.nombre] || 0) + item.cantidad;
});
}
});
document.getElementById('totalVendido').textContent = totalVendido.toLocaleString();
document.getElementById('mesasAtendidas').textContent = mesas.size;
document.getElementById('pedidosPagados').textContent = pedidosCount;
document.getElementById('articulosVendidos').textContent = Object.values(articulos).reduce((a,b) => a+b, 0);
const topArticulos = Object.entries(articulos)
.sort((a, b) => b[1] - a[1])
.slice(0, 5);
if (topArticulos.length === 0) {
document.getElementById('topArticulos').innerHTML = '<p style="text-align:center; color:#94a3b8;">No hay ventas hoy</p>';
} else {
let html = '<ul style="list-style:none; padding:0;">';
topArticulos.forEach(([nombre, cantidad]) => {
html += `<li style="padding:8px 0; border-bottom:1px solid #334155;">${nombre} ‚Ä¢ ${cantidad} veces</li>`;
});
html += '</ul>';
document.getElementById('topArticulos').innerHTML = html;
}
} catch (error) {
console.error("Error al cargar cierre de caja:", error);
document.getElementById('topArticulos').innerHTML = '<p style="text-align:center; color:#f87171;">Error al cargar datos</p>';
}
}
async function cargarMesas(tenantId) {
try {
const mesasSnapshot = await db.collection(`tenants/${tenantId}/mesas`).get();
const mesas = [];
mesasSnapshot.forEach(doc => mesas.push({ id: doc.id, ...doc.data() }));
renderMesas(mesas);
} catch (error) {
document.getElementById('mesasContainer').innerHTML = `<p style="text-align: center; color: #f87171;">Error: ${error.message}</p>`;
}
}
async function cargarArticulos(tenantId) {
try {
const articulosSnapshot = await db.collection(`tenants/${tenantId}/articulos`).get();
const articulos = [];
articulosSnapshot.forEach(doc => articulos.push({ id: doc.id, ...doc.data() }));
renderMenu(articulos);
} catch (error) {
document.getElementById('menuContainer').innerHTML = `<p style="text-align: center; color: #f87171;">Error: ${error.message}</p>`;
}
}
async function init() {
try {
const data = getMeseroData();
if (!data || !data.meseroId || !data.tenantId) {
throw new Error('URL inv√°lida. Acceda desde el panel de administraci√≥n.');
}
currentMesero = { id: data.meseroId, nombre: data.meseroNombre };
currentTenantId = data.tenantId;
document.getElementById('meseroNombre').textContent = `Panel de ${currentMesero.nombre}`;
//document.getElementById('tenantInfo').textContent = `Tenant: ${currentTenantId.substring(0, 8)}...`
cargarMesas(currentTenantId);
} catch (error) {
document.getElementById('view-mesas').innerHTML = `
<div class="card error">
<h2>‚ùå Acceso Denegado</h2>
<p>${error.message}</p>
<button onclick="window.location.href='index.html'" class="btn btn-primary" style="margin-top: 20px;">
Volver al Login
</button>
</div>
`;
}
}
document.addEventListener('DOMContentLoaded', init);
// Cargar QR del admin (almacenado como base64 en Firestore)
async function cargarQrDesdeAdmin() {
  if (!currentTenantId) return;
  
  try {
    const qrDoc = await db.collection('tenants').doc(currentTenantId).collection('configuracion').doc('qrPago').get();
    
    console.log("Documento QR:", qrDoc.exists ? qrDoc.data() : "No existe");
    
    const img = document.getElementById('qrPagoMesero');
    const placeholder = document.getElementById('qrPlaceholderMesero');
    const contenedor = document.getElementById('contenedorQr');
    
    if (qrDoc.exists && qrDoc.data().base64String) {
      const mimeType = qrDoc.data().mimeType || 'image/png';
      img.src = `${mimeType};base64,${qrDoc.data().base64String}`;
      img.style.display = 'block';
      placeholder.style.display = 'none';
      contenedor.style.display = 'block';
    } else {
      placeholder.textContent = 'Campo base64String vac√≠o o no existe';
      contenedor.style.display = 'block';
    }
  } catch (error) {
    console.error('Error al cargar QR:', error);
  }
}

// Cargar y mostrar QR solo cuando se selecciona Nequi/Daviplata
document.getElementById('formaPago').addEventListener('change', async function() {
  const contenedorQr = document.getElementById('contenedorQr');
  
  if (this.value === 'nequi' || this.value === 'daviplata') {
    if (!currentTenantId) {
      contenedorQr.style.display = 'none';
      return;
    }
    
    try {
      contenedorQr.style.display = 'block';
      const placeholder = document.getElementById('qrPlaceholderMesero');
      placeholder.textContent = 'Cargando c√≥digo QR...';
      
      const qrDoc = await db.collection('tenants').doc(currentTenantId).collection('configuracion').doc('qrPago').get();
      
      // ‚úÖ CORREGIDO: Usar "base64String" (el nombre REAL del campo)
      if (qrDoc.exists && qrDoc.data().base64String) {
        const mimeType = qrDoc.data().mimeType || 'image/png';
        const img = document.getElementById('qrPagoMesero');
        img.src = `${mimeType};base64,${qrDoc.data().base64String}`;
        img.style.display = 'block';
        placeholder.style.display = 'none';
      } else {
        placeholder.textContent = 'No hay c√≥digo QR configurado';
        placeholder.style.display = 'block';
        document.getElementById('qrPagoMesero').style.display = 'none';
      }
    } catch (error) {
      console.error('Error al cargar QR:', error);
      document.getElementById('qrPlaceholderMesero').textContent = 'Error al cargar QR';
    }
  } else {
    contenedorQr.style.display = 'none';
  }
});
</script>
<!-- Footer -->
<div style="text-align: center; margin-top: 30px; padding: 15px; color: #94a3b8; font-size: 13px; background: rgba(0,0,0,0.2); border-radius: 12px;">
<img src="https://raw.githubusercontent.com/appyem/imagenesappy/refs/heads/main/ChatGPT%20Image%2030%20dic%202025%2C%2007_50_08%20p.m..png" alt="AppyEmpresa S.A.S" style="width: 30px; height: 30px; object-fit: contain; vertical-align: middle; margin-right: 6px;">
Desarrollado por AppyEmpresa S.A.S
</div>
</body>
</html>

