<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel de Mesero</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
    body { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); min-height: 100vh; padding: 16px; }
    .container { max-width: 1200px; margin: 0 auto; }
    .header { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; padding: 20px; border-radius: 16px; margin-bottom: 24px; }
    .header-content h1 { font-size: 24px; font-weight: 700; margin-bottom: 4px; }
    .header-content p { font-size: 14px; opacity: 0.9; }
    .tabs { display: flex; overflow-x: auto; padding: 8px 0; margin-bottom: 24px; background: white; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .tab-btn { padding: 12px 24px; border: none; background: none; font-size: 16px; font-weight: 600; color: #6b7280; cursor: pointer; border-radius: 8px; white-space: nowrap; margin: 0 4px; }
    .tab-btn.active { background: #dbeafe; color: #1d4ed8; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .card { background: white; border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .error { text-align: center; padding: 40px; color: #ef4444; }
    /* Mesas por zona */
    .zonas-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 16px; }
    .zona-card { border-radius: 12px; padding: 16px; }
    .zona-title { font-weight: 600; margin-bottom: 12px; color: #1d4ed8; }
    .mesa-item { padding: 10px; margin: 4px 0; background: #f8fafc; border-radius: 8px; cursor: pointer; transition: background 0.2s; }
    .mesa-item:hover { background: #dbeafe; }
    .mesa-item.selected { background: #dbeafe; border-left: 4px solid #1d4ed8; }
    /* Men√∫ */
    .categorias-filtros { margin-bottom: 16px; }
    .categoria-btn { padding: 6px 12px; margin: 0 4px 8px 0; border: 1px solid #e2e8f0; border-radius: 20px; background: white; cursor: pointer; }
    .categoria-btn.active { background: #dbeafe; border-color: #1d4ed8; color: #1d4ed8; }
    .articulos-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
    .articulo-card { border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px; }
    .articulo-nombre { font-weight: 600; margin-bottom: 4px; }
    .articulo-precio { color: #059669; font-weight: 700; }
    .articulo-stock { font-size: 12px; color: #64748b; margin-top: 4px; }
    .agregar-btn { background: #10b981; color: white; border: none; padding: 6px 12px; border-radius: 6px; margin-top: 8px; cursor: pointer; font-size: 14px; }
    /* Carrito */
    .carrito-items { margin-bottom: 16px; }
    .carrito-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e2e8f0; }
    .carrito-total { font-size: 20px; font-weight: 700; text-align: right; margin-top: 16px; color: #059669; }
    .crear-pedido-btn { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 16px; }
    /* DJ Form */
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 14px; }
    .form-group input, .form-group select { width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 16px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-content">
        <h1 id="meseroNombre">Cargando Panel...</h1>
        <p id="tenantInfo">Verificando acceso...</p>
      </div>
    </div>

    <div class="tabs">
      <button class="tab-btn active" data-tab="mesas">ü™ë Mesas</button>
      <button class="tab-btn" data-tab="menu">üçé Men√∫</button>
      <button class="tab-btn" data-tab="carrito">üõí Carrito</button>
      <button class="tab-btn" data-tab="pedidos">üìã Pedidos</button>
      <button class="tab-btn" data-tab="pagos">üí∞ Pagos</button>
      <button class="tab-btn" data-tab="dj">üéµ DJ</button>
    </div>

    <div id="contentArea">
      <div class="card">
        <p style="text-align: center;">Cargando datos del mesero...</p>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    // Configuraci√≥n de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCYuZRqdrR4ZcQ97T6lU8vIqFw58cSM4hA",
      authDomain: "manager-pro-ec292.firebaseapp.com",
      projectId: "manager-pro-ec292",
      storageBucket: "manager-pro-ec292.firebasestorage.app",
      messagingSenderId: "1077289364014",
      appId: "1:1077289364014:web:a6bcea3c7ea2923ad4cdbf"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Variables globales
    let currentMesero = null;
    let currentTenantId = null;
    let currentMesaId = null;
    let carrito = [];

    // ‚úÖ Extraer datos de la URL
    function getMeseroData() {
      const params = new URLSearchParams(window.location.search);
      const dataParam = params.get('data');
      if (!dataParam) return null;
      
      try {
        const decoded = decodeURIComponent(dataParam);
        const jsonStr = atob(decoded);
        return JSON.parse(jsonStr);
      } catch (e) {
        console.error('Error al decodificar datos:', e);
        return null;
      }
    }

    // ‚úÖ Renderizar mesas
    function renderMesas(mesas) {
      const zonas = ['Terraza', 'Bar Principal', 'Zona VIP', 'Pista de Baile'];
      let html = '';
      zonas.forEach(zona => {
        const mesasZona = mesas.filter(m => m.ubicacion === zona);
        if (mesasZona.length > 0) {
          html += `<div class="zona-card"><div class="zona-title">${zona}</div>`;
          mesasZona.forEach(mesa => {
            html += `<div class="mesa-item" onclick="seleccionarMesa('${mesa.id}', '${mesa.numero}')">Mesa ${mesa.numero} ‚Ä¢ Cap: ${mesa.capacidad}</div>`;
          });
          html += '</div>';
        }
      });
      document.getElementById('mesasContainer').innerHTML = html || '<p style="text-align: center; color: #6b7280;">No hay mesas disponibles</p>';
    }

    // ‚úÖ Renderizar men√∫
    function renderMenu(articulos) {
      const categorias = [...new Set(articulos.map(a => a.categoria).filter(c => c))];
      let html = '<div class="categorias-filtros"><button class="categoria-btn active" onclick="filtrarCategoria(\'all\')">Todos</button>';
      categorias.forEach(cat => {
        html += `<button class="categoria-btn" onclick="filtrarCategoria('${cat}')">${cat}</button>`;
      });
      html += '</div><div class="articulos-grid">';
      articulos.forEach(art => {
        html += `<div class="articulo-card"><div class="articulo-nombre">${art.nombre}</div><div class="articulo-precio">$${art.precio.toLocaleString()}</div><div class="articulo-stock">Stock: ${art.stock}</div><button class="agregar-btn" onclick="agregarAlCarrito('${art.id}', '${art.nombre}', ${art.precio})">+</button></div>`;
      });
      html += '</div>';
      document.getElementById('menuContainer').innerHTML = html;
    }

    // ‚úÖ Renderizar pedidos
    function renderPedidos(pedidos) {
      if (pedidos.length === 0) {
        document.getElementById('pedidosContainer').innerHTML = '<p style="text-align: center; color: #6b7280;">No hay pedidos activos</p>';
        return;
      }

      let html = '<div class="pedidos-list">';
      pedidos.forEach(pedido => {
        const total = pedido.total?.toLocaleString() || '0';
        const estado = pedido.estado === 'pendiente' ? '‚è≥ Pendiente' : '‚úÖ Pagado';
        const mesaNumero = pedido.mesaNumero || pedido.mesaId;
        html += `
          <div class="card" style="margin-bottom: 16px;">
            <h3>Pedido #${pedido.id.substring(0, 6)}</h3>
            <p><strong>Mesa:</strong> ${mesaNumero}</p>
            <p><strong>Estado:</strong> ${estado}</p>
            <p><strong>Total:</strong> $${total}</p>
            <div style="margin-top: 12px;">
              <h4>Art√≠culos:</h4>
              <ul style="list-style: none; padding-left: 0;">
                ${pedido.items?.map(item => 
                  `<li>‚Ä¢ ${item.nombre} x${item.cantidad}</li>`
                ).join('') || '<li>Sin art√≠culos</li>'}
              </ul>
            </div>
          </div>
        `;
      });
      html += '</div>';
      document.getElementById('pedidosContainer').innerHTML = html;
    }

    // ‚úÖ Funciones globales
    function seleccionarMesa(mesaId, mesaNumero) {
      currentMesaId = mesaId;
      document.querySelectorAll('.mesa-item').forEach(item => item.classList.remove('selected'));
      event.target.classList.add('selected');
      alert(`‚úÖ Mesa ${mesaNumero} seleccionada`);
    }

    function agregarAlCarrito(articuloId, nombre, precio) {
      carrito.push({ id: articuloId, nombre, precio, cantidad: 1 });
      actualizarCarrito();
    }

    function filtrarCategoria(categoria) {
      document.querySelectorAll('.categoria-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
    }

    function actualizarCarrito() {
      if (carrito.length === 0) {
        document.getElementById('carritoContainer').innerHTML = '<p style="text-align: center; color: #6b7280;">Carrito vac√≠o</p>';
        return;
      }
      let html = '<div class="carrito-items">', total = 0;
      carrito.forEach(item => {
        const subtotal = item.precio * item.cantidad;
        total += subtotal;
        html += `<div class="carrito-item"><span>${item.nombre} x${item.cantidad}</span><span>$${subtotal.toLocaleString()}</span></div>`;
      });
      html += '</div>';
      html += `<div class="carrito-total">Total: $${total.toLocaleString()}</div>`;
      html += `<button class="crear-pedido-btn" onclick="crearPedido()">Crear Pedido</button>`;
      document.getElementById('carritoContainer').innerHTML = html;
    }

    // ‚úÖ FUNCI√ìN √öNICA crearPedido (sin duplicado)
    async function crearPedido() {
      if (!currentMesaId || carrito.length === 0) return alert('‚ö†Ô∏è Selecciona mesa y agrega art√≠culos');
      try {
        // Buscar n√∫mero de mesa
        let mesaNumero = 'Desconocida';
        const mesasSnapshot = await db.collection(`tenants/${currentTenantId}/mesas`).get();
        mesasSnapshot.forEach(doc => {
          if (doc.id === currentMesaId) {
            mesaNumero = doc.data().numero;
          }
        });

        const pedido = {
          mesaId: currentMesaId,
          mesaNumero: mesaNumero,
          meseroId: currentMesero.id,
          meseroNombre: currentMesero.nombre,
          items: carrito,
          total: carrito.reduce((sum, item) => sum + (item.precio * item.cantidad), 0),
          estado: 'pendiente',
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        await db.collection(`tenants/${currentTenantId}/pedidos`).add(pedido);
        carrito = [];
        actualizarCarrito();
        alert('‚úÖ Pedido creado exitosamente');
        
        // ‚úÖ Actualizar pedidos inmediatamente
        cargarPedidos(currentTenantId);
      } catch (error) {
        alert('‚ùå Error al crear pedido: ' + error.message);
      }
    }

    async function solicitarCancion() {
      const cancion = document.getElementById('cancionInput').value;
      const artista = document.getElementById('artistaInput').value;
      if (!currentMesaId || !cancion) return alert('‚ö†Ô∏è Selecciona mesa e ingresa canci√≥n');
      try {
        let mesaNumero = 'Desconocida';
        const mesas = await db.collection(`tenants/${currentTenantId}/mesas`).get();
        mesas.forEach(doc => { if (doc.id === currentMesaId) mesaNumero = doc.data().numero; });
        const peticion = {
          mesa: mesaNumero,
          cancion,
          artista: artista || null,
          mesero: currentMesero.nombre,
          estado: 'pendiente',
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        await db.collection(`tenants/${currentTenantId}/peticionesCancion`).add(peticion);
        document.getElementById('cancionInput').value = '';
        document.getElementById('artistaInput').value = '';
        alert('‚úÖ Petici√≥n enviada al DJ');
      } catch (error) {
        alert('‚ùå Error: ' + error.message);
      }
    }

    // ‚úÖ Cargar datos de Firestore
    async function cargarMesas(tenantId) {
      try {
        const mesasSnapshot = await db.collection(`tenants/${tenantId}/mesas`).get();
        const mesas = [];
        mesasSnapshot.forEach(doc => mesas.push({ id: doc.id, ...doc.data() }));
        renderMesas(mesas);
      } catch (error) {
        document.getElementById('mesasContainer').innerHTML = `<p style="text-align: center; color: #ef4444;">Error: ${error.message}</p>`;
      }
    }

    async function cargarArticulos(tenantId) {
      try {
        const articulosSnapshot = await db.collection(`tenants/${tenantId}/articulos`).get();
        const articulos = [];
        articulosSnapshot.forEach(doc => articulos.push({ id: doc.id, ...doc.data() }));
        renderMenu(articulos);
      } catch (error) {
        document.getElementById('menuContainer').innerHTML = `<p style="text-align: center; color: #ef4444;">Error: ${error.message}</p>`;
      }
    }

    // ‚úÖ CORREGIDO: sin orderBy() para evitar necesidad de √≠ndice compuesto
    async function cargarPedidos(tenantId) {
      if (!currentMesero?.id) {
        console.warn("No se puede cargar pedidos: mesero no definido");
        document.getElementById('pedidosContainer').innerHTML = '<p style="text-align: center; color: #6b7280;">No hay pedidos activos</p>';
        return;
      }
      try {
        // üî• REMOVEMOS orderBy() para evitar error de √≠ndice
        const pedidosSnapshot = await db.collection(`tenants/${tenantId}/pedidos`)
          .where('meseroId', '==', currentMesero.id)
          .get();
        
        const pedidos = [];
        pedidosSnapshot.forEach(doc => {
          pedidos.push({ id: doc.id, ...doc.data() });
        });

        // üî• Ordenamos manualmente en JavaScript (cliente)
        pedidos.sort((a, b) => {
          const aTime = a.createdAt?.seconds || 0;
          const bTime = b.createdAt?.seconds || 0;
          return bTime - aTime; // descendente
        });
        
        renderPedidos(pedidos);
      } catch (error) {
        console.error("Error al cargar pedidos:", error);
        document.getElementById('pedidosContainer').innerHTML = `<p style="text-align: center; color: #ef4444;">Error al cargar pedidos: ${error.message}</p>`;
      }
    }

    // ‚úÖ Cargar contenido del cashier
    function loadCashierContent() {
      document.getElementById('contentArea').innerHTML = `
        <div class="tab-content active" id="tab-mesas">
          <div class="card">
            <h2>ü™ë Selecci√≥n de Mesa</h2>
            <p>Selecciona la mesa que deseas atender</p>
            <div id="mesasContainer">
              <p style="text-align: center; color: #6b7280;">Cargando mesas...</p>
            </div>
          </div>
        </div>
        <div class="tab-content" id="tab-menu">
          <div class="card">
            <h2>üçé Men√∫ de Bebidas</h2>
            <div id="menuContainer">
              <p style="text-align: center; color: #6b7280;">Cargando men√∫...</p>
            </div>
          </div>
        </div>
        <div class="tab-content" id="tab-carrito">
          <div class="card">
            <h2>üõí Carrito de Pedidos</h2>
            <div id="carritoContainer">
              <p style="text-align: center; color: #6b7280;">Carrito vac√≠o</p>
            </div>
          </div>
        </div>
        <div class="tab-content" id="tab-pedidos">
          <div class="card">
            <h2>üìã Pedidos Activos</h2>
            <div id="pedidosContainer">
              <p style="text-align: center; color: #6b7280;">Cargando pedidos...</p>
            </div>
          </div>
        </div>
        <div class="tab-content" id="tab-pagos">
          <div class="card">
            <h2>üí∞ Registro de Pagos</h2>
            <div id="pagosContainer">
              <p style="text-align: center; color: #6b7280;">Listo para procesar pagos</p>
            </div>
          </div>
        </div>
        <div class="tab-content" id="tab-dj">
          <div class="card">
            <h2>üéµ Solicitar Canciones al DJ</h2>
            <div class="form-group">
              <label for="cancionInput">Nombre de la Canci√≥n *</label>
              <input type="text" id="cancionInput" placeholder="Despacito" required>
            </div>
            <div class="form-group">
              <label for="artistaInput">Artista (opcional)</label>
              <input type="text" id="artistaInput" placeholder="Luis Fonsi">
            </div>
            <button class="submit-btn" onclick="solicitarCancion()" style="background: linear-gradient(135deg, #4c1d95 0%, #7e22ce 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%;">Enviar al DJ</button>
            <div id="djContainer" style="margin-top: 20px;"><p style="text-align: center; color: #6b7280;">Listo para enviar peticiones</p></div>
          </div>
        </div>
      `;

      // Configurar tabs con recarga autom√°tica de pedidos
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          this.classList.add('active');
          const tabId = 'tab-' + this.getAttribute('data-tab');
          document.getElementById(tabId).classList.add('active');

          // ‚úÖ Recargar pedidos al entrar a la pesta√±a
          if (this.getAttribute('data-tab') === 'pedidos') {
            cargarPedidos(currentTenantId);
          }
        });
      });

      // Cargar datos iniciales
      cargarMesas(currentTenantId);
      cargarArticulos(currentTenantId);
      cargarPedidos(currentTenantId);
    }

    // ‚úÖ Inicializaci√≥n
    async function init() {
      try {
        const data = getMeseroData();
        if (!data || !data.meseroId || !data.tenantId) {
          throw new Error('URL inv√°lida. Acceda desde el panel de administraci√≥n.');
        }

        currentMesero = { id: data.meseroId, nombre: data.meseroNombre };
        currentTenantId = data.tenantId;

        document.getElementById('meseroNombre').textContent = `Panel de ${currentMesero.nombre}`;
        document.getElementById('tenantInfo').textContent = `Tenant: ${currentTenantId.substring(0, 8)}...`;

        loadCashierContent();
      } catch (error) {
        document.getElementById('contentArea').innerHTML = `
          <div class="card error">
            <h2>‚ùå Acceso Denegado</h2>
            <p>${error.message}</p>
            <button onclick="window.location.href='index.html'" 
                    style="margin-top: 20px; background: #3b82f6; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">
              Volver al Login
            </button>
          </div>
        `;
      }
    }

    // Iniciar cuando el DOM est√© listo
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>

