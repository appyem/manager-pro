<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gesti√≥n de Bar - Sistema Integral</title>
  <style>
* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
body {
  background: #0f172a url('https://raw.githubusercontent.com/appyem/imagens-manager-pro/refs/heads/main/ChatGPT%20Image%208%20ene%202026%2C%2004_10_16%20p.m..png') center/cover fixed;
  color: #e2e8f0;
  min-height: 100vh;
  padding: 16px;
}
.container { max-width: 1200px; margin: 0 auto; }

/* Login */
.login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; }
.login-card,
.register-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(12px);
  border-radius: 20px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  padding: 40px;
  width: 100%;
  max-width: 450px;
  text-align: center;
  border: 1px solid rgba(255, 255, 255, 0.1);
}
.login-card h1 { font-size: 28px; font-weight: 700; color: #f1f5f9; margin-bottom: 8px; }
.login-card p { color: #cbd5e1; margin-bottom: 24px; font-size: 16px; }
.form-group { margin-bottom: 20px; text-align: left; }
.form-group label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: #e2e8f0;
  font-size: 14px;
}
.form-group input, .form-group select {
  width: 100%;
  padding: 14px 16px;
  border: 2px solid #334155;
  border-radius: 12px;
  font-size: 16px;
  background: #1e293b;
  color: white;
  transition: border-color 0.2s;
}
.form-group input:focus, .form-group select:focus {
  outline: none;
  border-color: #C7794E;
}
.login-btn {
  width: 100%;
  padding: 14px;
  background: linear-gradient(135deg, #C7794E 0%, #8A9B68 100%);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 18px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  margin-bottom: 12px;
  box-shadow: 0 4px 12px rgba(199, 121, 78, 0.3);
}
.login-btn:hover {
  transform: translateY(-2px);
  opacity: 0.95;
}
.register-link {
  color: #93c5fd;
  text-decoration: underline;
  cursor: pointer;
  font-weight: 600;
}

/* Register Form */
.register-container { display: none; min-height: 100vh; padding: 20px; }
.register-card {
  background: #252f40;
  border-radius: 20px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
  padding: 40px;
  border: 1px solid #334155;
}

/* Plans */
.plans-section { margin: 30px 0; }
.plans-header { text-align: center; margin-bottom: 24px; }
.plans-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
.plan-card {
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 24px;
  text-align: center;
  transition: all 0.3s;
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(12px);
}
.plan-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 25px rgba(199, 121, 78, 0.2);
  border-color: #C7794E;
}
.plan-popular {
  border-color: #8A9B68;
  position: relative;
}
.plan-popular::before {
  content: 'M√ÅS POPULAR';
  position: absolute;
  top: -12px;
  left: 50%;
  transform: translateX(-50%);
  background: #8A9B68;
  color: white;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
}
.plan-name { font-size: 18px; font-weight: 700; color: #f1f5f9; margin-bottom: 8px; }
.plan-price { font-size: 28px; font-weight: 700; color: #C7794E; margin-bottom: 12px; }
.plan-duration { font-size: 14px; color: #94a3b8; margin-bottom: 16px; }
.plan-features { list-style: none; margin-bottom: 20px; }
.plan-features li { padding: 4px 0; color: #cbd5e1; }
.plan-btn {
  width: 100%;
  padding: 12px;
  background: #C7794E;
  color: white;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.2s;
}
.plan-btn:hover { background: #b46542; }

/* WhatsApp Button */
.whatsapp-btn {
  background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
  color: white;
  border: none;
  padding: 16px 24px;
  border-radius: 12px;
  font-size: 18px;
  font-weight: 600;
  cursor: pointer;
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  margin-top: 20px;
  transition: transform 0.2s;
}
.whatsapp-btn:hover {
  transform: translateY(-2px);
  opacity: 0.95;
}

/* Dashboard */
#dashboard { display: none; }
.header {
  background: rgba(255, 255, 255, 0.15);
  backdrop-filter: blur(12px);
  color: white;
  padding: 20px;
  border-radius: 16px;
  margin-bottom: 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
  border: 1px solid rgba(255, 255, 255, 0.1);
}
.tabs {
  display: flex;
  overflow-x: auto;
  padding: 8px 0;
  margin-bottom: 24px;
  background: #252f40;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  border: 1px solid #334155;
}
.tab-btn {
  padding: 12px 24px;
  border: none;
  background: none;
  font-size: 16px;
  font-weight: 600;
  color: #cbd5e1;
  cursor: pointer;
  border-radius: 8px;
  white-space: nowrap;
  margin: 0 4px;
  transition: all 0.2s;
}
.tab-btn.active {
  background: rgba(199, 121, 78, 0.25);
  color: #f1f5f9;
}
.tab-btn:hover:not(.active) {
  background: #334155;
  color: #f1f5f9;
}
.tab-content { display: none; }
.tab-content.active { display: block; }

/* Stats */
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 32px; }
.stat-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(12px);
  border-radius: 16px;
  padding: 24px;
  text-align: center;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.1);
}
.stat-card.libre { border-top: 4px solid #8A9B68; }
.stat-card.pendiente { border-top: 4px solid #C7794E; }
.stat-card.pagada { border-top: 4px solid #4ade80; }
.stat-card.total { border-top: 4px solid #C7794E; }
.stat-label { font-size: 14px; color: #94a3b8; margin-bottom: 8px; }
.stat-value { font-size: 32px; font-weight: 700; margin-bottom: 4px; }
.stat-value.green { color: #8A9B68; }
.stat-value.yellow { color: #C7794E; }
.stat-value.blue { color: #4ade80; }
.stat-value.pink { color: #C7794E; }

/* Tables */
.tables-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 32px; }
.table-card {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(12px);
  border-radius: 16px;
  padding: 24px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.1);
}
.table-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}
.table-number { font-size: 20px; font-weight: 700; color: #f1f5f9; }
.table-status {
  padding: 6px 16px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
}
.table-status.libre { background: #8A9B68; color: #121826; }
.table-status.pendiente { background: #C7794E; color: #121826; }
.table-status.pagada { background: #4ade80; color: #121826; }
.table-location { font-size: 14px; color: #94a3b8; margin-bottom: 8px; }
.table-capacity { font-size: 14px; color: #94a3b8; }

/* Forms */
.form-section,
.list-section {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(12px);
  border-radius: 16px;
  padding: 24px;
  margin-bottom: 24px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.1);
}
.form-section h2, .list-section h2 {
  font-size: 20px;
  font-weight: 700;
  color: #f1f5f9;
  margin-bottom: 24px;
}
.form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 24px; }
.form-group.full { grid-column: 1 / -1; }
.submit-btn {
  background: linear-gradient(135deg, #C7794E 0%, #8A9B68 100%);
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  box-shadow: 0 4px 12px rgba(199, 121, 78, 0.3);
}
.submit-btn:hover {
  transform: translateY(-2px);
}

/* Lists */
.list-item {
  padding: 16px;
  border-bottom: 1px solid #334155;
}
.list-item:last-child { border-bottom: none; }
.list-item-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}
.list-item-title { font-weight: 600; font-size: 16px; color: #f1f5f9; }
.list-item-detail { font-size: 14px; color: #94a3b8; }
.action-buttons { display: flex; gap: 12px; margin-top: 12px; }
.action-btn {
  padding: 6px 12px;
  border: none;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
}
.action-btn.copy { background: #334155; color: #cbd5e1; }
.action-btn.whatsapp { background: #25D366; color: white; }
.action-btn.confirm { background: #8A9B68; color: white; }
.action-btn.reject { background: #ef4444; color: white; }
.action-btn.restock { background: #C7794E; color: white; }

/* Stock Alert */
.stock-alert { color: #f87171; font-weight: bold; }

@media (max-width: 768px) {
  .register-card { padding: 30px 20px; }
  .plans-grid, .stats-grid, .tables-grid, .form-grid { grid-template-columns: 1fr; }
  .tab-btn { padding: 10px 16px; font-size: 14px; }
}
</style>


</head>
<body>
  <div class="container">
    <!-- Login Screen -->
    <div id="login" class="login-container">
      <div class="login-card">
      <div class="login-icon">
        <img src="https://raw.githubusercontent.com/appyem/imagenesappy/refs/heads/main/ChatGPT%20Image%206%20ene%202026%2C%2006_33_51%20p.m..png" alt="AppyEmpresa S.A.S" style="width: 60px; height: 60px; object-fit: contain;">
      </div>
        <h1>Gesti√≥n de Bar</h1>
        <p>Sistema Integral para Bares y Restaurantes</p>
        
        <div class="form-group">
          <label for="loginEmail">Email</label>
          <input type="email" id="loginEmail" placeholder="tu@bar.com" required>
        </div>
        <div class="form-group">
          <label for="loginPassword">Contrase√±a</label>
          <input type="password" id="loginPassword" placeholder="tu contrase√±a" required>
        </div>
        
        <button class="login-btn" onclick="iniciarSesion()">üîê Iniciar Sesi√≥n</button>
        <p style="font-size: 14px; color: #94a3b8;">
          ¬øNo tienes cuenta? <span class="register-link" onclick="showRegister()">Solicita tu cuenta aqu√≠</span>
        </p>
      </div>
    </div>

    <!-- Register Form -->
    <div id="register" class="register-container">
      <div class="register-card">
        <div class="register-header">
         <div style="text-align: center; margin-bottom: 16px;">
            <img src="https://raw.githubusercontent.com/appyem/imagenesappy/refs/heads/main/ChatGPT%20Image%206%20ene%202026%2C%2006_33_51%20p.m..png" alt="AppyEmpresa S.A.S" style="width: 50px; height: 50px; object-fit: contain;">
          </div>
          <h1>Solicita tu Cuenta</h1>
          <p>Completa el formulario y elige tu plan de suscripci√≥n</p>
        </div>
        
        <form id="registerForm">
          <div class="form-grid">
            <div class="form-group">
              <label for="fullName">Nombre Completo *</label>
              <input type="text" id="fullName" placeholder="Juan P√©rez" required>
            </div>
            <div class="form-group">
              <label for="businessName">Nombre del Negocio *</label>
              <input type="text" id="businessName" placeholder="Bar El Trago" required>
            </div>
            <div class="form-group">
              <label for="email">Email *</label>
              <input type="email" id="email" placeholder="tu@bar.com" required>
            </div>
            <div class="form-group">
              <label for="phone">Tel√©fono *</label>
              <input type="tel" id="phone" placeholder="3106524453" required>
            </div>
          </div>
          
          <div class="plans-section">
            <div class="plans-header">
              <h2>üìä Elige tu Plan</h2>
              <p>Todos los planes incluyen: Meseros ilimitados, Art√≠culos ilimitados, Soporte 24/7</p>
            </div>
            
            <div class="plans-grid">
              <div class="plan-card">
                <div class="plan-name">Prueba</div>
                <div class="plan-price">$100.000</div>
                <div class="plan-duration">15 d√≠as</div>
                <ul class="plan-features">
                  <li>‚úì Meseros ilimitados</li>
                  <li>‚úì Art√≠culos ilimitados</li>
                  <li>‚úì Soporte b√°sico</li>
                </ul>
                <button type="button" class="plan-btn" onclick="selectPlan('Prueba - 15 d√≠as - $100.000')">Seleccionar</button>
              </div>
              
              <div class="plan-card plan-popular">
                <div class="plan-name">Est√°ndar</div>
                <div class="plan-price">$400.000</div>
                <div class="plan-duration">3 meses</div>
                <ul class="plan-features">
                  <li>‚úì Meseros ilimitados</li>
                  <li>‚úì Art√≠culos ilimitados</li>
                  <li>‚úì Soporte prioritario</li>
                  <li>‚úì Reportes avanzados</li>
                </ul>
                <button type="button" class="plan-btn" onclick="selectPlan('Est√°ndar - 3 meses - $400.000')">Seleccionar</button>
              </div>
              
              <div class="plan-card">
                <div class="plan-name">Profesional</div>
                <div class="plan-price">$700.000</div>
                <div class="plan-duration">6 meses</div>
                <ul class="plan-features">
                  <li>‚úì Meseros ilimitados</li>
                  <li>‚úì Art√≠culos ilimitados</li>
                  <li>‚úì Soporte 24/7</li>
                  <li>‚úì Reportes avanzados</li>
                  <li>‚úì Personalizaci√≥n</li>
                </ul>
                <button type="button" class="plan-btn" onclick="selectPlan('Profesional - 6 meses - $700.000')">Seleccionar</button>
              </div>
              
              <div class="plan-card">
                <div class="plan-name">Premium</div>
                <div class="plan-price">$990.000</div>
                <div class="plan-duration">1 a√±o</div>
                <ul class="plan-features">
                  <li>‚úì Meseros ilimitados</li>
                  <li>‚úì Art√≠culos ilimitados</li>
                  <li>‚úì Soporte 24/7 VIP</li>
                  <li>‚úì Reportes avanzados</li>
                  <li>‚úì Personalizaci√≥n completa</li>
                  <li>‚úì Actualizaciones prioritarias</li>
                </ul>
                <button type="button" class="plan-btn" onclick="selectPlan('Premium - 1 a√±o - $990.000')">Seleccionar</button>
              </div>
            </div>
          </div>
          
          <input type="hidden" id="selectedPlan" required>
          
          <button type="button" class="whatsapp-btn" onclick="enviarWhatsApp()">
            <span class="whatsapp-icon">üí¨</span>
            Enviar Solicitud por WhatsApp
          </button>
          
          <button type="button" style="margin-top: 15px; background: none; border: none; color: #94a3b8; cursor: pointer;" onclick="showLogin()">
            ‚Üê Volver al Login
          </button>
        </form>
      </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard">
      <div class="header">
        <div>
          <h1 id="barName">Panel de Administrador</h1>
          <p id="tenantInfo" style="font-size: 12px; opacity: 0.9;">Negocio: <span id="tenantIdDisplay"></span></p>
        </div>
        <button class="logout-btn" onclick="cerrarSesion()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">Cerrar Sesi√≥n</button>
      </div>
      
      <div class="tabs">
        <button class="tab-btn active" onclick="showTab('dashboard')">
          <img src="https://raw.githubusercontent.com/appyem/imagens-manager-pro/refs/heads/main/icono%20dash.png" alt="Dashboard" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 6px;">
          Dashboard
        </button>
        <button class="tab-btn" onclick="showTab('meseros')">
          <img src="https://raw.githubusercontent.com/appyem/imagens-manager-pro/refs/heads/main/icono%20mesero.png" alt="Meseros" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 6px;">
          Meseros
        </button>
        <button class="tab-btn" onclick="showTab('mesas')">ü™ë Mesas</button>
        <button class="tab-btn" onclick="showTab('articulos')">
          <img src="https://raw.githubusercontent.com/appyem/imagens-manager-pro/refs/heads/main/icono%20articlos.png" alt="Art√≠culos" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 6px;">
          Art√≠culos
        </button>
        <button class="tab-btn" onclick="showTab('pagos')">üí∞ Pagos</button>
        <button class="tab-btn" onclick="showTab('cierre')">
          <img src="https://raw.githubusercontent.com/appyem/imagens-manager-pro/refs/heads/main/ciere%20de%20caja.png" alt="Cierre de Caja" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 6px;">
          Cierre de Caja
        </button>
        <button class="tab-btn" onclick="showTab('dj')">üéß DJ</button>
        <button class="tab-btn" onclick="showTab('qr')">üì± QR Pago</button>
        <button class="tab-btn" onclick="showTab('reportes')">üìà Reportes</button>
        </div>
      
      <!-- Dashboard Tab -->
      <div class="tab-content active" id="tab-dashboard">
        <div class="stats-grid">
          <div class="stat-card libre">
            <div class="stat-label">Mesas Libres</div>
            <div class="stat-value green" id="mesasLibres">0</div>
          </div>
          <div class="stat-card pendiente">
            <div class="stat-label">Pendientes</div>
            <div class="stat-value yellow" id="mesasPendientes">0</div>
          </div>
          <div class="stat-card pagada">
            <div class="stat-label">Pagadas</div>
            <div class="stat-value blue" id="mesasPagadas">0</div>
          </div>
          <div class="stat-card total">
            <div class="stat-label">Total Ventas</div>
            <div class="stat-value pink" id="totalVentas">$0</div>
          </div>
        </div>
        
        <h2 style="font-size: 20px; font-weight: 700; color: #f8fafc; margin-bottom: 20px;">Estado de Mesas</h2>
        <div class="tables-grid" id="tablesContainer">
          <!-- Mesas se cargar√°n aqu√≠ -->
        </div>
      </div>
      
      <!-- Meseros Tab -->
      <div class="tab-content" id="tab-meseros">
        <div class="form-section">
          <h2>Crear Nuevo Mesero</h2>
          <form class="form-grid" onsubmit="crearMesero(event)">
            <div class="form-group">
              <label for="nombreMesero">Nombre</label>
              <input type="text" id="nombreMesero" placeholder="Nombre del mesero" required>
            </div>
            <div class="form-group">
              <label for="telefonoMesero">Tel√©fono</label>
              <input type="tel" id="telefonoMesero" placeholder="3001234567" required>
            </div>
            <div class="form-group full">
              <button type="submit" class="submit-btn">Crear Mesero</button>
            </div>
          </form>
        </div>
        
        <div class="list-section">
          <h2>Meseros (<span id="meserosCount">0</span>)</h2>
          <div id="meserosList">
            <!-- Lista de meseros -->
          </div>
        </div>
      </div>
      
      <!-- Mesas Tab -->
      <div class="tab-content" id="tab-mesas">
        <div class="form-section">
          <h2>Crear Nueva Mesa</h2>
          <form class="form-grid" onsubmit="crearMesa(event)">
            <div class="form-group">
              <label for="numeroMesa">N√∫mero</label>
              <input type="text" id="numeroMesa" placeholder="1, 2, A, B..." required>
            </div>
            <div class="form-group">
              <label for="ubicacionMesa">Ubicaci√≥n</label>
              <select id="ubicacionMesa" required>
                <option value="">Seleccionar ubicaci√≥n</option>
                <option value="Zona VIP">Zona VIP</option>
                <option value="Pista de Baile">Pista de Baile</option>
                <option value="Terraza">Terraza</option>
                <option value="Bar Principal">Bar Principal</option>
              </select>
            </div>
            <div class="form-group">
              <label for="capacidadMesa">Capacidad</label>
              <input type="number" id="capacidadMesa" min="1" value="4" required>
            </div>
            <div class="form-group full">
              <button type="submit" class="submit-btn">Crear Mesa</button>
            </div>
          </form>
        </div>
        
        <div class="list-section">
          <h2>Mesas (<span id="mesasCount">0</span>)</h2>
          <div id="mesasList">
            <!-- Lista de mesas -->
          </div>
        </div>
      </div>
      
      <!-- Art√≠culos Tab -->
      <div class="tab-content" id="tab-articulos">
        <div class="form-section">
          <h2>Crear Nuevo Art√≠culo</h2>
          <form class="form-grid" onsubmit="crearArticulo(event)">
            <div class="form-group">
              <label for="nombreArticulo">Nombre</label>
              <input type="text" id="nombreArticulo" placeholder="Aguardiente Antioque√±o" required>
            </div>
            <div class="form-group">
              <label for="categoriaArticulo">Categor√≠a</label>
              <select id="categoriaArticulo" required>
                <option value="">Seleccionar categor√≠a</option>
                <option value="Aguardiente">Aguardiente</option>
                <option value="Ron">Ron</option>
                <option value="Whisky">Whisky</option>
                <option value="Vodka">Vodka</option>
                <option value="Cerveza">Cerveza</option>
              </select>
            </div>
            <div class="form-group">
              <label for="precioArticulo">Precio ($)</label>
              <input type="number" id="precioArticulo" min="1" placeholder="25000" required>
            </div>
            <div class="form-group">
              <label for="stockArticulo">Stock Inicial</label>
              <input type="number" id="stockArticulo" min="1" value="24" required>
            </div>
            <div class="form-group full">
              <button type="submit" class="submit-btn">Crear Art√≠culo</button>
            </div>
          </form>
        </div>
        
        <div class="list-section">
          <h2>Art√≠culos (<span id="articulosCount">0</span>)</h2>
          <div id="articulosList">
            <!-- Lista de art√≠culos -->
          </div>
        </div>
      </div>
      
      <!-- Pagos Tab -->
      <div class="tab-content" id="tab-pagos">
        <div class="list-section">
          <h2>Pagos Pendientes de Confirmaci√≥n</h2>
          <div id="pagosPendientes">
            <p style="text-align: center; color: #94a3b8; padding: 20px;">No hay pagos pendientes</p>
          </div>
        </div>
      </div>
      
      <!-- Cierre de Caja Tab -->
      <div class="tab-content" id="tab-cierre">
        <div class="form-section">
          <h2>CloseOperation Caja Diario</h2>
          <div class="stats-grid">
            <div class="stat-card total">
              <div class="stat-label">Total Vendido</div>
              <div class="stat-value pink" id="cierreTotal">$0</div>
            </div>
            <div class="stat-card blue">
              <div class="stat-label">Mesas Atendidas</div>
              <div class="stat-value blue" id="cierreMesas">0</div>
            </div>
            <div class="stat-card green">
              <div class="stat-label">Pagos Confirmados</div>
              <div class="stat-value green" id="cierrePagos">0</div>
            </div>
            <div class="stat-card yellow">
              <div class="stat-label">Pagos Pendientes</div>
              <div class="stat-value yellow" id="cierrePendientes">0</div>
            </div>
          </div>
          
          <div class="form-group">
            <label for="cierreFecha">Fecha</label>
            <input type="date" id="cierreFecha" value="2026-01-07" readonly style="background:#0f172a;">
          </div>
          
          <button class="submit-btn" onclick="generarCierreCaja()">CloseOperation Caja y Generar Reporte</button>
        </div>
      </div>
      
      <!-- DJ Tab -->
      <div class="tab-content" id="tab-dj">
        <div class="form-section">
          <h2>üéß Configuraci√≥n del DJ</h2>
          <p style="color: #94a3b8; margin-bottom: 20px;">Genera la URL √∫nica para que el DJ reciba las peticiones de canciones de tus meseros.</p>
          
          <div class="form-group">
            <label>URL del DJ</label>
            <div style="display: flex; gap: 10px; margin-top: 8px;">
              <input type="text" id="djUrl" readonly style="flex:1; background:#0f172a; color:white; border:2px solid #334155; border-radius:8px; padding:10px;">
              <button class="action-btn copy" onclick="copiarDjUrl()">Copiar</button>
            </div>
          </div>
          
          <div class="action-buttons" style="margin-top: 20px;">
            <button class="action-btn whatsapp" onclick="enviarDjWhatsApp()">Enviar por WhatsApp</button>
          </div>
        </div>
      </div>
      
      <!-- Reportes Tab -->
      <div class="tab-content" id="tab-reportes">
        <div class="form-section">
          <h2>Filtros de Reporte</h2>
          <div class="form-grid">
            <div class="form-group">
              <label for="reporteDesde">Desde</label>
              <input type="date" id="reporteDesde" required>
            </div>
            <div class="form-group">
              <label for="reporteHasta">Hasta</label>
              <input type="date" id="reporteHasta" required>
            </div>
            <div class="form-group full">
              <button class="submit-btn" onclick="generarReporte()">Generar Reporte</button>
            </div>
          </div>
        </div>
        
        <div class="stats-grid">
          <div class="stat-card total">
            <div class="stat-label">Ventas Totales</div>
            <div class="stat-value pink" id="ventasTotales">$0</div>
          </div>
          <div class="stat-card blue">
            <div class="stat-label">Pedidos Totales</div>
            <div class="stat-value blue" id="pedidosTotales">0</div>
          </div>
          <div class="stat-card green">
            <div class="stat-label">Pedidos Pagados</div>
            <div class="stat-value green" id="pedidosPagados">0</div>
          </div>
          <div class="stat-card yellow">
            <div class="stat-label">Pedidos Pendientes</div>
            <div class="stat-value yellow" id="pedidosPendientes">0</div>
          </div>
        </div>
        
        <div class="list-section">
          <h2>Historia de Transacciones</h2>
          <div id="transaccionesList">
            <p style="text-align: center; color: #94a3b8; padding: 20px;">No hay transacciones</p>
          </div>
        </div>
      </div>

      <!-- QR Pago Tab -->
      <div class="tab-content" id="tab-qr">
        <div class="form-section">
          <h2>üì± C√≥digo QR de Pago</h2>
          <p style="color: #94a3b8; margin-bottom: 20px;">Sube el c√≥digo QR de tu cuenta Nequi, Daviplata o transferencia.</p>

          <div style="text-align: center; margin: 20px 0;">
            <div style="width: 200px; height: 200px; margin: 0 auto; border: 2px dashed #334155; border-radius: 12px; background: #0f172a; display: flex; align-items: center; justify-content: center; position: relative;">
              <img id="qrPreviewImage" src="" alt="C√≥digo QR" style="max-width: 100%; max-height: 100%; object-fit: contain; display: none;">
              <span id="qrPlaceholderText" style="color: #94a3b8; font-size: 14px;">No hay c√≥digo QR cargado</span>
            </div>
          </div>

          <div class="form-group" style="margin-top: 20px;">
            <input type="file" id="qrFileInput" accept="image/png, image/jpeg" style="width: 100%; padding: 10px; background: #0f172a; border: 2px solid #334155; border-radius: 8px; color: white; font-size: 14px;">
          </div>

          <button class="submit-btn" onclick="subirCodigoQR()" style="margin-top: 12px; width: 100%;">üì§ Subir C√≥digo QR</button>

          <div style="margin-top: 15px; padding: 12px; background: rgba(51, 65, 85, 0.3); border-radius: 8px; font-size: 12px; color: #cbd5e1;">
            <strong>Formatos aceptados:</strong> PNG, JPG<br>
            <strong>Tama√±o m√°ximo:</strong> 1MB
          </div>
        </div>
      </div>
        
       
          <div class="stat-card total">
            <div class="stat-label">Ventas Totales</div>
            <div class="stat-value pink" id="ventasTotales">$0</div>
          </div>
          <div class="stat-card blue">
            <div class="stat-label">Pedidos Totales</div>
            <div class="stat-value blue" id="pedidosTotales">0</div>
          </div>
          <div class="stat-card green">
            <div class="stat-label">Pedidos Pagados</div>
            <div class="stat-value green" id="pedidosPagados">0</div>
          </div>
          <div class="stat-card yellow">
            <div class="stat-label">Pedidos Pendientes</div>
            <div class="stat-value yellow" id="pedidosPendientes">0</div>
          </div>
        </div>
        
       
          <h2>Historia de Transacciones</h2>
          <div id="transaccionesList">
            <p style="text-align: center; color: #94a3b8; padding: 20px;">No hay transacciones</p>
          </div>
       </div>
    </div>
  </div>


  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    // === CONFIGURACI√ìN DE FIREBASE ===
    const firebaseConfig = {
      apiKey: "AIzaSyCYuZRqdrR4ZcQ97T6lU8vIqFw58cSM4hA",
      authDomain: "manager-pro-ec292.firebaseapp.com",
      projectId: "manager-pro-ec292",
      storageBucket: "manager-pro-ec292.firebasestorage.app",
      messagingSenderId: "1077289364014",
      appId: "1:1077289364014:web:a6bcea3c7ea2923ad4cdbf"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth(); // ‚úÖ AUTH INCLUIDO
    const db = firebase.firestore();

    // === VARIABLES GLOBALES (declaradas UNA SOLA VEZ) ===
    let currentUser = null;
    let tenantId = null;
    let mesasUnsubscribe = null; // ‚úÖ √öNICA DECLARACI√ìN

    // === FUNCIONES DE REGISTRO Y LOGIN (100% FUNCIONALES) ===
    async function crearTenant(userId, email) {
      const tenantRef = db.collection('tenants').doc(userId);
      await tenantRef.set({
        name: `Bar de ${email.split('@')[0]}`,
        email: email,
        owner: userId,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    }

    window.iniciarSesion = async function() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      if (!email || !password) {
        alert('‚ö†Ô∏è Por favor ingresa email y contrase√±a');
        return;
      }
      try {
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        currentUser = userCredential.user;
        tenantId = userCredential.user.uid;
        document.getElementById('barName').textContent = `Panel de ${email}`;
        document.getElementById('tenantIdDisplay').textContent = tenantId.substring(0, 8) + '...';
        showDashboard();
        cargarDatos();
        generarUrlDj();
      } catch (error) {
        alert('‚ùå Credenciales incorrectas o cuenta no activada.\n\nContacta al soporte para activar tu cuenta.');
      }
    };

    window.showRegister = function() {
      document.getElementById('login').style.display = 'none';
      document.getElementById('register').style.display = 'block';
      document.getElementById('dashboard').style.display = 'none';
    };

    window.showLogin = function() {
      document.getElementById('login').style.display = 'block';
      document.getElementById('register').style.display = 'none';
      document.getElementById('dashboard').style.display = 'none';
    };

    window.selectPlan = function(plan) {
      document.getElementById('selectedPlan').value = plan;
      document.querySelectorAll('.plan-btn').forEach(btn => {
        btn.style.background = '#8b5cf6';
      });
      event.target.style.background = '#7c3aed';
    };

    window.enviarWhatsApp = function() {
      const fullName = document.getElementById('fullName').value;
      const businessName = document.getElementById('businessName').value;
      const email = document.getElementById('email').value;
      const phone = document.getElementById('phone').value;
      const selectedPlan = document.getElementById('selectedPlan').value;
      if (!fullName || !businessName || !email || !phone || !selectedPlan) {
        alert('‚ö†Ô∏è Por favor completa todos los campos y selecciona un plan');
        return;
      }
      const mensaje = `¬°Hola! Quisiera solicitar una cuenta para el sistema de gesti√≥n de bares.\n\n` +
                     `üìã Datos del solicitante:\n` +
                     `‚Ä¢ Nombre: ${fullName}\n` +
                     `‚Ä¢ Negocio: ${businessName}\n` +
                     `‚Ä¢ Email: ${email}\n` +
                     `‚Ä¢ Tel√©fono: ${phone}\n\n` +
                     `üí∞ Plan seleccionado:\n` +
                     `‚Ä¢ ${selectedPlan}\n\n` +
                     `¬øPodr√≠an ayudarme con el proceso de activaci√≥n? ¬°Gracias!`;
      const whatsappUrl = `https://wa.me/573106524453?text=${encodeURIComponent(mensaje)}`;
      window.location.href = whatsappUrl;
    };

    window.cerrarSesion = async function() {
      if (mesasUnsubscribe) mesasUnsubscribe();
      await auth.signOut();
      currentUser = null;
      tenantId = null;
      showLogin();
    };

    window.showDashboard = function() {
      document.getElementById('login').style.display = 'none';
      document.getElementById('register').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
    };

    window.showTab = function(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById('tab-' + tabName).classList.add('active');
      event.target.classList.add('active');
      if (tabName === 'pagos') {
        cargarPagosPendientes();
      } else if (tabName === 'cierre') {
        cargarCierreCaja();
      } else if (tabName === 'dj') {
        generarUrlDj();
      } else if (tabName === 'reportes') {
        const today = new Date();
        const lastWeek = new Date(today);
        lastWeek.setDate(today.getDate() - 7);
        document.getElementById('reporteHasta').valueAsDate = today;
        document.getElementById('reporteDesde').valueAsDate = lastWeek;
        cargarPedidosAdmin();
      } else if (tabName === 'mesas') {
        if (tenantId) {
          db.collection(`tenants/${tenantId}/mesas`).get().then(snapshot => {
            const mesas = [];
            snapshot.forEach(doc => mesas.push({ id: doc.id, ...doc.data() }));
            renderMesas(mesas);
          }).catch(error => {
            console.error("Error al cargar mesas:", error);
            document.getElementById('mesasList').innerHTML = `<p style="text-align: center; color: #ef4444;">Error: ${error.message}</p>`;
          });
        }
      } else if (tabName === 'qr') {
        // ‚úÖ CARGAR EL C√ìDIGO QR AL ENTRAR A LA PESTA√ëA
        cargarCodigoQR();
      }
    };

    // === FUNCIONES DE DATOS (SIN DUPLICADOS) ===
    async function cargarDatos() {
      if (!tenantId) return;
      if (mesasUnsubscribe) mesasUnsubscribe();
      
      const mesasRef = db.collection(`tenants/${tenantId}/mesas`);
      mesasUnsubscribe = mesasRef.onSnapshot((snapshot) => {
        const mesas = [];
        snapshot.forEach(doc => mesas.push({ id: doc.id, ...doc.data() }));
        actualizarDashboard(mesas);
        if (document.getElementById('tab-mesas').classList.contains('active')) {
          renderMesas(mesas);
        }
      }, (error) => {
        console.error("Error al escuchar mesas:", error);
        alert('‚ùå Error al cargar mesas: ' + error.message);
      });

      const meserosSnapshot = await db.collection(`tenants/${tenantId}/meseros`).get();
      const meseros = [];
      meserosSnapshot.forEach(doc => meseros.push({ id: doc.id, ...doc.data() }));
      renderMeseros(meseros);

      const articulosSnapshot = await db.collection(`tenants/${tenantId}/articulos`).get();
      const articulos = [];
      articulosSnapshot.forEach(doc => articulos.push({ id: doc.id, ...doc.data() }));
      renderArticulos(articulos);

      await cargarPedidosAdmin();
    }

    async function crearMeseroFirebase(nombre, telefono) {
      if (!tenantId) return;
      const urlUnica = nombre
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9\s]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .replace(/^-|-$/g, '');
      await db.collection(`tenants/${tenantId}/meseros`).add({
        nombre,
        telefono,
        urlUnica,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      cargarDatos();
    }

    async function eliminarMesero(id) {
      if (!tenantId || !confirm('¬øEst√°s seguro de eliminar este mesero?')) return;
      try {
        const meseroRef = db.collection(`tenants/${tenantId}/meseros`).doc(id);
        await meseroRef.delete();
        cargarDatos();
        alert('‚úÖ Mesero eliminado exitosamente');
      } catch (error) {
        alert('‚ùå Error al eliminar mesero: ' + error.message);
      }
    }

    async function crearMesaFirebase(numero, ubicacion, capacidad) {
      if (!tenantId) return;
      await db.collection(`tenants/${tenantId}/mesas`).add({
        numero, ubicacion, capacidad: parseInt(capacidad), estado: 'libre', createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      cargarDatos();
    }

    async function eliminarMesa(id) {
      if (!tenantId || !confirm('¬øEst√°s seguro de eliminar esta mesa?')) return;
      try {
        const mesaRef = db.collection(`tenants/${tenantId}/mesas`).doc(id);
        await mesaRef.delete();
        cargarDatos();
        alert('‚úÖ Mesa eliminada exitosamente');
      } catch (error) {
        alert('‚ùå Error al eliminar mesa: ' + error.message);
      }
    }

    async function crearArticuloFirebase(nombre, categoria, precio, stock) {
      if (!tenantId) return;
      await db.collection(`tenants/${tenantId}/articulos`).add({
        nombre, categoria, precio: parseFloat(precio), stock: parseInt(stock), createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      cargarDatos();
    }

    function actualizarDashboard(mesas) {
      const libre = mesas.filter(m => m.estado === 'libre').length;
      const pendiente = mesas.filter(m => m.estado === 'pendiente').length;
      const pagada = mesas.filter(m => m.estado === 'pagada').length;
      const totalPendiente = pendiente * 25000;
      
      document.getElementById('mesasLibres').textContent = libre;
      document.getElementById('mesasPendientes').textContent = pendiente;
      document.getElementById('mesasPagadas').textContent = pagada;
      document.getElementById('totalVentas').textContent = '$' + totalPendiente.toLocaleString();
      
      const container = document.getElementById('tablesContainer');
      container.innerHTML = '';
      
      mesas.forEach(mesa => {
        const card = document.createElement('div');
        card.className = 'table-card';
        card.innerHTML = `
          <div class="table-header">
            <div class="table-number">Mesa ${mesa.numero}</div>
            <div class="table-status ${mesa.estado || 'libre'}">${mesa.estado === 'libre' ? 'Libre' : mesa.estado === 'pendiente' ? 'Pendiente' : 'Pagada'}</div>
          </div>
          <div class="table-location">${mesa.ubicacion || 'Sin ubicaci√≥n'}</div>
          <div class="table-capacity">Capacidad: ${mesa.capacidad || 4} personas</div>
        `;
        container.appendChild(card);
      });
    }

    function renderMeseros(meseros) {
      document.getElementById('meserosCount').textContent = meseros.length;
      const container = document.getElementById('meserosList');
      container.innerHTML = '';
      meseros.forEach(mesero => {
        const div = document.createElement('div');
        div.className = 'list-item';
        div.innerHTML = `
          <div class="list-item-header">
            <div class="list-item-title">${mesero.nombre}</div>
          </div>
          <div class="list-item-detail">Tel: ${mesero.telefono}</div>
          <div class="list-item-detail">ID: ${mesero.id}</div>
          <div class="action-buttons">
            <button class="action-btn copy" onclick="copiarURL('${mesero.id}', '${mesero.nombre}', '${tenantId}')">Copiar URL</button>
            <button class="action-btn whatsapp" onclick="enviarWhatsAppMesero('${mesero.nombre}', '${mesero.telefono}', '${mesero.id}', '${tenantId}')">WhatsApp</button>
            <button class="action-btn" style="background: #ef4444; color: white;" onclick="eliminarMesero('${mesero.id}')">Eliminar</button>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function renderMesas(mesas) {
      document.getElementById('mesasCount').textContent = mesas.length;
      const container = document.getElementById('mesasList');
      container.innerHTML = '';
      mesas.forEach(mesa => {
        const div = document.createElement('div');
        div.className = 'list-item';
        div.innerHTML = `
          <div class="list-item-header">
            <div class="list-item-title">Mesa ${mesa.numero}</div>
          </div>
          <div class="list-item-detail">Ubicaci√≥n: ${mesa.ubicacion}</div>
          <div class="list-item-detail">Capacidad: ${mesa.capacidad} personas</div>
          <div class="action-buttons" style="margin-top: 10px;">
            <button class="action-btn" style="background: #ef4444; color: white;" onclick="eliminarMesa('${mesa.id}')">Eliminar</button>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function renderArticulos(articulos) {
      document.getElementById('articulosCount').textContent = articulos.length;
      const container = document.getElementById('articulosList');
      container.innerHTML = '';
      articulos.forEach(articulo => {
        let stockClass = '';
        if (articulo.stock < 5) {
          stockClass = ' stock-alert';
        }
        const div = document.createElement('div');
        div.className = 'list-item';
        div.innerHTML = `
          <div class="list-item-header">
            <div class="list-item-title">${articulo.nombre}</div>
          </div>
          <div class="list-item-detail">Categor√≠a: ${articulo.categoria || 'Sin categor√≠a'}</div>
          <div class="list-item-detail">Precio: $${(articulo.precio || 0).toLocaleString()}</div>
          <div class="list-item-detail${stockClass}">Stock: ${articulo.stock || 0}</div>
          <div class="action-buttons" style="margin-top: 10px;">
            <button class="action-btn restock" onclick="reabastecerArticulo('${articulo.id}', '${articulo.nombre}')">Reabastecer</button>
          </div>
        `;
        container.appendChild(div);
      });
    }

    // === FUNCIONES DEL POS PROFESIONAL ===
    async function cargarPedidosAdmin() {
      if (!tenantId) return;
      try {
        const pedidosSnapshot = await db.collection(`tenants/${tenantId}/pedidos`).get();
        let total = 0;
        let pendientes = 0;
        let pagados = 0;
        let totales = 0;
        
        pedidosSnapshot.forEach(doc => {
          const pedido = doc.data();
          totales++;
          if (pedido.estado === 'pendiente') {
            pendientes++;
            total += pedido.total || 0;
          } else if (pedido.estado === 'pagada' || pedido.estado === 'confirmado') {
            pagados++;
            total += pedido.total || 0;
          }
        });
        
        document.getElementById('pedidosTotales').textContent = totales;
        document.getElementById('pedidosPendientes').textContent = pendientes;
        document.getElementById('pedidosPagados').textContent = pagados;
        document.getElementById('ventasTotales').textContent = '$' + total.toLocaleString();
        document.getElementById('totalVentas').textContent = '$' + total.toLocaleString();
        
        const transaccionesList = document.getElementById('transaccionesList');
        if (transaccionesList) {
          let html = '';
          const pedidosArray = [];
          pedidosSnapshot.forEach(doc => pedidosArray.push({ id: doc.id, ...doc.data() }));
          pedidosArray.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
          const ultimos = pedidosArray.slice(0, 10);
          if (ultimos.length === 0) {
            transaccionesList.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 20px;">No hay transacciones</p>';
          } else {
            html = '<ul style="list-style: none; padding: 0;">';
            ultimos.forEach(p => {
              const estado = p.estado === 'pendiente' ? 'Pendiente' : p.estado === 'pagada' ? 'Pagado (Pendiente Confirmaci√≥n)' : 'Confirmado';
              html += `<li style="padding: 8px 0; border-bottom: 1px solid #334155;">
                <strong>Pedido #${p.id.substring(0,6)}</strong> - $${(p.total || 0).toLocaleString()} - ${estado}
              </li>`;
            });
            html += '</ul>';
            transaccionesList.innerHTML = html;
          }
        }
      } catch (error) {
        console.error("Error al cargar pedidos del admin:", error);
      }
    }

    async function cargarPagosPendientes() {
      if (!tenantId) return;
      try {
        const pedidosSnapshot = await db.collection(`tenants/${tenantId}/pedidos`)
          .where('estado', '==', 'pagada')
          .get();
        
        const container = document.getElementById('pagosPendientes');
        if (pedidosSnapshot.empty) {
          container.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 20px;">No hay pagos pendientes</p>';
          return;
        }
        
        let html = '';
        pedidosSnapshot.forEach(doc => {
          const p = doc.data();
          html += `
            <div class="list-item">
              <div class="list-item-header">
                <div class="list-item-title">Pedido #${doc.id.substring(0,6)} - Mesa ${p.mesaNumero || p.mesaId}</div>
              </div>
              <div class="list-item-detail">Total: $${(p.total || 0).toLocaleString()}</div>
              <div class="list-item-detail">Mesero: ${p.meseroNombre}</div>
              <div class="list-item-detail">Forma de Pago: ${p.formaPago || 'Efectivo'}</div>
              <div class="action-buttons">
                <button class="action-btn confirm" onclick="confirmarPago('${doc.id}')">‚úÖ Confirmar Pago</button>
                <button class="action-btn reject" onclick="rechazarPago('${doc.id}')">‚ùå Rechazar</button>
              </div>
            </div>
          `;
        });
        container.innerHTML = html;
      } catch (error) {
        console.error("Error al cargar pagos pendientes:", error);
        document.getElementById('pagosPendientes').innerHTML = `<p style="text-align: center; color: #ef4444;">Error: ${error.message}</p>`;
      }
    }

    async function confirmarPago(pedidoId) {
      if (!confirm('¬øConfirmar que el pago fue recibido correctamente?')) return;
      try {
        await db.collection(`tenants/${tenantId}/pedidos`).doc(pedidoId).update({
          estado: 'confirmado',
          confirmadoAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        alert('‚úÖ Pago confirmado exitosamente');
        cargarPagosPendientes();
        cargarPedidosAdmin();
        const pedidoDoc = await db.collection(`tenants/${tenantId}/pedidos`).doc(pedidoId).get();
        const pedido = pedidoDoc.data();
        if (pedido.mesaId) {
          await db.collection(`tenants/${tenantId}/mesas`).doc(pedido.mesaId).update({ estado: 'libre' });
        }
        cargarDatos();
      } catch (error) {
        alert('‚ùå Error al confirmar pago: ' + error.message);
      }
    }

    async function rechazarPago(pedidoId) {
      if (!confirm('¬øRechazar este pago? El pedido volver√° a estado pendiente.')) return;
      try {
        await db.collection(`tenants/${tenantId}/pedidos`).doc(pedidoId).update({
          estado: 'pendiente'
        });
        alert('üîÑ Pago rechazado. Pedido vuelve a estado pendiente.');
        cargarPagosPendientes();
        cargarPedidosAdmin();
      } catch (error) {
        alert('‚ùå Error al rechazar pago: ' + error.message);
      }
    }

    async function cargarCierreCaja() {
      if (!tenantId) return;
      const hoy = new Date();
      hoy.setHours(0, 0, 0, 0);
      const hoyTimestamp = firebase.firestore.Timestamp.fromDate(hoy);
      
      try {
        const pedidosSnapshot = await db.collection(`tenants/${tenantId}/pedidos`)
          .where('pagadoAt', '>=', hoyTimestamp)
          .get();
        
        let totalVendido = 0;
        let mesas = new Set();
        let confirmados = 0;
        let pendientes = 0;
        
        pedidosSnapshot.forEach(doc => {
          const p = doc.data();
          totalVendido += p.total || 0;
          if (p.mesaId) mesas.add(p.mesaId);
          if (p.estado === 'confirmado') confirmados++;
          if (p.estado === 'pagada') pendientes++;
        });
        
        document.getElementById('cierreTotal').textContent = '$' + totalVendido.toLocaleString();
        document.getElementById('cierreMesas').textContent = mesas.size;
        document.getElementById('cierrePagos').textContent = confirmados;
        document.getElementById('cierrePendientes').textContent = pendientes;
        document.getElementById('cierreFecha').valueAsDate = hoy;
      } catch (error) {
        console.error("Error al cargar cierre de caja:", error);
      }
    }

    async function generarCierreCaja() {
      if (!confirm('¬øCerrar caja para el d√≠a de hoy? Esta acci√≥n marcar√° todos los pagos pendientes como revisados.')) return;
      try {
        const hoy = new Date();
        hoy.setHours(0, 0, 0, 0);
        const hoyTimestamp = firebase.firestore.Timestamp.fromDate(hoy);
        
        const pedidosSnapshot = await db.collection(`tenants/${tenantId}/pedidos`)
          .where('pagadoAt', '>=', hoyTimestamp)
          .where('estado', '==', 'pagada')
          .get();
        
        const batch = db.batch();
        pedidosSnapshot.docs.forEach(doc => {
          batch.update(doc.ref, { estado: 'cerrado' });
        });
        
        await batch.commit();
        alert('‚úÖ Caja cerrada exitosamente. Reporte generado.');
        cargarCierreCaja();
        cargarPagosPendientes();
      } catch (error) {
        alert('‚ùå Error al cerrar caja: ' + error.message);
      }
    }

    async function generarReporte() {
      const desde = document.getElementById('reporteDesde').value;
      const hasta = document.getElementById('reporteHasta').value;
      
      if (!desde || !hasta) {
        alert('‚ö†Ô∏è Selecciona ambas fechas');
        return;
      }
      
      const desdeDate = new Date(desde);
      const hastaDate = new Date(hasta);
      hastaDate.setHours(23, 59, 59, 999);
      
      const desdeTimestamp = firebase.firestore.Timestamp.fromDate(desdeDate);
      const hastaTimestamp = firebase.firestore.Timestamp.fromDate(hastaDate);
      
      try {
        const pedidosSnapshot = await db.collection(`tenants/${tenantId}/pedidos`)
          .where('createdAt', '>=', desdeTimestamp)
          .where('createdAt', '<=', hastaTimestamp)
          .get();
        
        let total = 0;
        let pendientes = 0;
        let pagados = 0;
        let totales = 0;
        
        const pedidosArray = [];
        pedidosSnapshot.forEach(doc => {
          const p = doc.data();
          pedidosArray.push({ id: doc.id, ...p });
          totales++;
          if (p.estado === 'pendiente') {
            pendientes++;
          } else if (p.estado === 'pagada' || p.estado === 'confirmado' || p.estado === 'cerrado') {
            pagados++;
            total += p.total || 0;
          }
        });
        
        document.getElementById('pedidosTotales').textContent = totales;
        document.getElementById('pedidosPendientes').textContent = pendientes;
        document.getElementById('pedidosPagados').textContent = pagados;
        document.getElementById('ventasTotales').textContent = '$' + total.toLocaleString();
        
        const transaccionesList = document.getElementById('transaccionesList');
        if (pedidosArray.length === 0) {
          transaccionesList.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 20px;">No hay transacciones en este periodo</p>';
        } else {
          let html = '<ul style="list-style: none; padding: 0;">';
          pedidosArray.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
          pedidosArray.forEach(p => {
            const estado = p.estado === 'pendiente' ? 'Pendiente' : p.estado === 'pagada' ? 'Pagado (Pendiente Confirmaci√≥n)' : 'Confirmado';
            html += `<li style="padding: 8px 0; border-bottom: 1px solid #334155;">
              <strong>Pedido #${p.id.substring(0,6)}</strong> - $${(p.total || 0).toLocaleString()} - ${estado}
            </li>`;
          });
          html += '</ul>';
          transaccionesList.innerHTML = html;
        }
      } catch (error) {
        alert('‚ùå Error al generar reporte: ' + error.message);
      }
    }

    async function reabastecerArticulo(articuloId, nombre) {
      const cantidad = prompt(`¬øCu√°ntas unidades deseas agregar a ${nombre}?`);
      if (cantidad && !isNaN(cantidad) && parseInt(cantidad) > 0) {
        try {
          const articuloRef = db.collection(`tenants/${tenantId}/articulos`).doc(articuloId);
          await articuloRef.update({
            stock: firebase.firestore.FieldValue.increment(parseInt(cantidad))
          });
          alert('‚úÖ Stock actualizado exitosamente');
          cargarDatos();
        } catch (error) {
          alert('‚ùå Error al actualizar stock: ' + error.message);
        }
      }
    }

    function generarUrlDj() {
      if (!tenantId) return;
      const datos = btoa(JSON.stringify({ tenantId }));
      const djUrl = `${window.location.origin}/dj.html?data=${encodeURIComponent(datos)}`;
      document.getElementById('djUrl').value = djUrl;
    }

    window.copiarDjUrl = function() {
      const url = document.getElementById('djUrl').value;
      if (url) {
        navigator.clipboard.writeText(url).then(() => {
          alert('‚úÖ URL del DJ copiada!');
        });
      }
    };

    window.enviarDjWhatsApp = function() {
      const url = document.getElementById('djUrl').value;
      if (!url) return;
      const mensaje = `Hola, accede al panel del DJ aqu√≠:\n${url}`;
      window.open(`https://wa.me/573106524453?text=${encodeURIComponent(mensaje)}`, '_blank');
    };

    // CRUD funciones
    window.crearMesero = async function(e) {
      e.preventDefault();
      const nombre = document.getElementById('nombreMesero').value;
      const telefono = document.getElementById('telefonoMesero').value;
      if (nombre && telefono) {
        await crearMeseroFirebase(nombre, telefono);
        document.getElementById('nombreMesero').value = '';
        document.getElementById('telefonoMesero').value = '';
      }
    };

    window.crearMesa = async function(e) {
      e.preventDefault();
      const numero = document.getElementById('numeroMesa').value;
      const ubicacion = document.getElementById('ubicacionMesa').value;
      const capacidad = document.getElementById('capacidadMesa').value;
      if (numero && ubicacion && capacidad) {
        await crearMesaFirebase(numero, ubicacion, capacidad);
        document.getElementById('numeroMesa').value = '';
        document.getElementById('ubicacionMesa').value = '';
        document.getElementById('capacidadMesa').value = '4';
      }
    };

    window.crearArticulo = async function(e) {
      e.preventDefault();
      const nombre = document.getElementById('nombreArticulo').value;
      const categoria = document.getElementById('categoriaArticulo').value;
      const precio = document.getElementById('precioArticulo').value;
      const stock = document.getElementById('stockArticulo').value;
      if (nombre && categoria && precio && stock) {
        await crearArticuloFirebase(nombre, categoria, precio, stock);
        document.getElementById('nombreArticulo').value = '';
        document.getElementById('categoriaArticulo').value = '';
        document.getElementById('precioArticulo').value = '';
        document.getElementById('stockArticulo').value = '24';
      }
    };

    // Utilidades
    window.copiarURL = function(meseroId, meseroNombre, tenantId) {
      const datos = btoa(JSON.stringify({
        meseroId,
        meseroNombre,
        tenantId
      }));
      const url = `${window.location.origin}/cashier.html?data=${encodeURIComponent(datos)}`;
      navigator.clipboard.writeText(url).then(() => {
        alert('‚úÖ URL copiada!\n' + url);
      });
    };

    window.enviarWhatsAppMesero = function(nombre, telefono, meseroId, tenantId) {
      const datos = btoa(JSON.stringify({
        meseroId,
        meseroNombre: nombre,
        tenantId
      }));
      const url = `${window.location.origin}/cashier.html?data=${encodeURIComponent(datos)}`;
      const mensaje = `Hola ${nombre}, accede aqu√≠: ${url}`;
      window.open(`https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`, '_blank');
    };

  // === FUNCIONES PARA C√ìDIGO QR DE PAGO (SIN STORAGE) ===
    function convertirImagenABase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = error => reject(error);
      });
    }

    async function subirCodigoQR() {
      const fileInput = document.getElementById('qrFileInput');
      const file = fileInput.files[0];
      
      if (!file) {
        alert('‚ö†Ô∏è Por favor selecciona una imagen del c√≥digo QR.');
        return;
      }
      
      if (!tenantId) {
        alert('‚ùå No hay sesi√≥n activa.');
        return;
      }
      
      const validTypes = ['image/png', 'image/jpeg'];
      if (!validTypes.includes(file.type)) {
        alert('‚ùå Solo se permiten archivos PNG o JPG.');
        return;
      }
      
      if (file.size > 1048576) {
        alert('‚ùå La imagen debe pesar menos de 1MB.');
        return;
      }
      
      try {
        const originalBtnText = document.querySelector('.submit-btn').textContent;
        document.querySelector('.submit-btn').textContent = '‚è≥ Procesando...';
        
        const base64String = await convertirImagenABase64(file);
        
        await db.collection('tenants').doc(tenantId).collection('configuracion').doc('qrPago').set({ 
          data: base64String,
          mimeType: file.type,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert('‚úÖ C√≥digo QR subido exitosamente.');
        cargarCodigoQR();
        document.querySelector('.submit-btn').textContent = originalBtnText;
      } catch (error) {
        console.error('Error al subir QR:', error);
        alert('‚ùå Error al procesar la imagen: ' + error.message);
        document.querySelector('.submit-btn').textContent = 'üì§ Subir C√≥digo QR';
      }
    }

    async function cargarCodigoQR() {
      if (!tenantId) return;
      
      try {
        const qrDoc = await db.collection('tenants').doc(tenantId).collection('configuracion').doc('qrPago').get();
        const img = document.getElementById('qrPreviewImage');
        const placeholder = document.getElementById('qrPlaceholderText');
        
        if (qrDoc.exists && qrDoc.data().data) {
          const mimeType = qrDoc.data().mimeType || 'image/png';
          img.src = `${mimeType};base64,${qrDoc.data().data}`;
          img.style.display = 'block';
          placeholder.style.display = 'none';
        } else {
          img.style.display = 'none';
          placeholder.style.display = 'block';
          placeholder.textContent = 'No hay c√≥digo QR cargado';
        }
      } catch (error) {
        console.error('Error al cargar QR:', error);
        document.getElementById('qrPlaceholderText').textContent = 'Error al cargar QR';
      }
    }

    // Modificar showTab para cargar QR autom√°ticamente
    const originalShowTab = window.showTab;
    window.showTab = function(tabName) {
      originalShowTab(tabName);
      if (tabName === 'qr') {
        cargarCodigoQR();
      }
    };

  </script>

  <!-- Footer -->
    <div style="text-align: center; margin-top: 40px; padding: 20px; color: #6b7280; font-size: 14px;">
      <img src="https://raw.githubusercontent.com/appyem/imagenesappy/refs/heads/main/ChatGPT%20Image%2030%20dic%202025%2C%2007_50_08%20p.m..png" alt="AppyEmpresa S.A.S" style="width: 40px; height: 40px; object-fit: contain; vertical-align: middle; margin-right: 8px;">
      Aplicaci√≥n desarrollada por AppyEmpresa S.A.S
    </div>
</body>
</html>

